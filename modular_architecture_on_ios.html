<h1 id="modular-architecture-on-ios-and-macos">Modular Architecture on iOS and macOS</h1>
<p>Building large scalable iOS/macOS apps and frameworks with Domain-Driven Design</p>
<p><strong>CFBundleVersion</strong> - 0.9.0 - Developer preview</p>
<h1 id="dedication">Dedication</h1>
<p>“To my Mom and Dad, because they really tried.”</p>
<p>&amp;&amp;</p>
<p>“To all my non-tech friends for whom I am always fixing various problems: not enough disk space, printers not working, forgotten passcodes etc., and who will never read this line.”</p>
<p>&amp;&amp;</p>
<p>“To all passionate engineers who are solving tough problems on a daily basis with a smile. It is great pleasure for everyone to work with you!”</p>
<p>&amp;&amp;</p>
<p>“Finally, to my current girlfriend … whoever she is”</p>
<h1 id="about-the-author">About the author</h1>
<p>Hi, I am Cyril, a software engineer by heart and the author of this book. Most of my professional career was spent building iOS apps or iOS frameworks. My professional career began at Skoda Auto Connect App in Prague, continued for Freelancer Ltd in Sydney building iOS platform, included numerous start-ups along the way, and, currently, has me as an iOS TechLead in Stuttgart for Porsche AG. In this book, I am describing different approaches for building modular iOS architectures and will be providing some mechanisms and essential knowledge that should help one decide which approach would fit the best or should be considered for a project.</p>
<h2 id="reviewer">Reviewer</h2>
<p>Highly likely due to the quality of this book the reviewer wishes to be secret.</p>
<h1 id="introduction">Introduction</h1>
<p>In the software engineering field, people are going from project to project, gaining a different kind of experience out of it. In particular, on iOS, mostly the monolithic approaches are used. In some cases it makes total sense, so nothing against it. However, scaling up the team, or even better, the team of teams on a monolithically built app is horrifying and nearly impossible without some major time impacts on a daily basis. Numerous problems will rise, that limit the way iOS projects are built or managed at the organisational level.</p>
<p>Scaling up the monolithic approach to a team of e.g 10+ developers will most likely result in hell. By hell, I mean, resolving <code>xcodeproj</code> issues, where in the worst case, both parties renamed, edited, or deleted the same source code file or touched the same {storyboard|xib} file. That is, both worked on the same file which would resolve in classic merge conflicts. Somehow, we all become accustomed to those issues and have learned we will just need to live with them.</p>
<p>The deal-breaker comes when your PO/PM/CTO/CEO or anybody higher on the company’s food chain than you are will come to the team to announce that he or she is planning to release a new flavour of the app or to divide the current app into two separate parts. Afterwards, the engineering decision needs to be made to either continue with the monolithic approach or implement something different. Continuing with the monolithic approach, likely would result in creating different targets, assigning files towards the new flavour of the app and continuing on living in multiplied hell all the while hoping that some requirement such as shipping core components of the app to a subsidiary or open-sourcing it as a framework will not come into play.</p>
<p>Not surprisingly, a better approach would be to start refactoring the app using a modular approach, where each team can be responsible for particular frameworks (parts of the app) that are then linked towards final customer-facing apps. That will most certainly take time as it will not be easy to transform it but the future of the company’s mobile engineering will be faster, scalable, maintainable and even ready to distribute or open-source some SDKs of it to the outer world.</p>
<p>Another scenario could be that you are already working on an app that is set up in a modular way but your app takes around 20 mins to compile because it is a huge legacy codebase that has been in development for the past eight or so years and has linked every possible 3rd party library along the way. The decision was made to modularise it with Cocoapods therefore, you cannot link easily already pre-compiled libraries with Carthage and every project clean means you can take a double shot of espresso. I have been there, trust me, it is another type of hell, definitely not a place where anyone would like to be. I described the whole migration process of such a project <a href="https://medium.com/freelancer-engineering/modular-architecture-on-ios-and-how-i-decreased-build-time-by-50-23c7666c6d2f">in an article on Medium in 2018</a>. Of course, in this book you will read about it in more detail.</p>
<p>Nowadays, as an iOS TechLead, I am often getting asked some questions all over again from new teams or new colleagues with regards to those topics. Thereafter, I decided to sum it up and tried to get the whole subject covered in this book. The purpose of it is to help developers working on such architectures to gain the background knowledge and experience in order to more quickly and correctly implement these ideas.</p>
<p>Hopefully, this introduction provided enough motivation that you will want to dive further into this book.</p>
<h2 id="what-you-need">What you Need</h2>
<p>The latest version of <a href="https://apps.apple.com/us/app/xcode/id497799835?mt=12">Xcode</a> for compiling the demo examples, <a href="https://brew.sh/">brew</a> to install some mandatory dependencies, <a href="https://www.ruby-lang.org/en/">Ruby</a>, and <a href="https://bundler.io/">bundler</a> for running scripts and downloading some ruby gems.</p>
<h2 id="what-is-this-book-about">What is this book about</h2>
<p>This book describes the essentials of building a modular architecture on iOS. You will find examples of different approaches, framework types, their pros and cons, common problems and so on. By the end of this book, you should have a very good understanding of what benefits such an architecture will bring to your project, whether it is necessary at all, and which way would be the best for modularising the project.</p>
<h2 id="what-is-this-book-not-about">What is this book NOT about</h2>
<p>SwiftUI.</p>
<h1 id="modular-architecture">Modular Architecture</h1>
<p><strong>Modular</strong>, <em>adjective - employing or involving a module or modules as the basis of design or construction: “modular housing units”</em></p>
<p>In the introduction, I briefly touched on the motivation for building the project in a modular way. To summarise, modular architecture will give us much more freedom when it comes to the product decisions that will influence the overall app engineering. These include building another app for the same company, open-sourcing some parts of the existing codebase, scaling the team of developers, and so on. With the already existing mobile foundation, the whole development process will be done way faster and cleaner.</p>
<p>To be fair, maintaining such a software foundation of a company might be also really difficult. By maintaining, I mean, taking care of the CI/CD (Continous Integration / Continous Delivery), maintaining old projects developed on top of the foundation that was heavily refactored in the meantime, legacy code, keeping it up-to-date with the latest development tools and so on. It goes without saying that on a very large project, this could be the work of one standalone team.</p>
<p>This book describes building such a large scalable architecture with domain-driven design and does so by using examples; The software foundation for the <a href="https://en.wikipedia.org/wiki/International_Space_Station">International Space Station</a>.</p>
<h2 id="design">Design</h2>
<p>In this book, I chose to use the architecture that I think is the most evolved. It is a five-layer architecture that consists of the following layers:</p>
<ul>
<li>Application</li>
<li>Domain</li>
<li>Service</li>
<li>Core</li>
<li>Shared</li>
</ul>
<p>Each layer is explained in the following chapter.</p>
<p>Nevertheless, the same principles can be applied for other architectural types as well. An example is a feature-oriented architecture where the layers could be defined as follows:</p>
<ul>
<li>Application</li>
<li>Feature</li>
<li>Core</li>
<li>Shared</li>
</ul>
<p>Now to the specific layers.</p>
<h2 id="layers">Layers</h2>
<p>Let us have a look now at each layer and its purpose. Modules within layers are then demonstrated with the example in the following chapter.</p>
<h3 id="application-layer">Application Layer</h3>
<p>The application layer consists of the final customer-facing products: applications. Applications glue all the different parts together, linking domains via configurations and a Scaffold module. In such architecture, the App is a container that puts pieces together.</p>
<p>Nevertheless, the App might also contain some necessary Application implementations like receiving push notifications, handling deep linking, requesting permissions, and so on.</p>
<p>Patterns that will help achieve such goals will be described later.</p>
<p>For example, an app in an e-commerce business could be <code>The Shop</code> for online customer and <code>Cashier</code> for the employees of that company.</p>
<h3 id="domain-layer">Domain Layer</h3>
<p>Domain layer links services and other modules from layers below and uses them to implement the business domain needs of the company or the project. Domains will contain, for example, the user flow within the particular domain part of the app. Furthermore, the domain will have the necessary components for the flow like; view controllers, views, models and view models. Obviously it depends on the team’s preferences and technical experience which pattern will be used for creating screens. Personally, the reactive MVVM+C is my favourite but more on that later.</p>
<p>Continuing with our example of an e-commerce app, a domain could be <code>Checkout</code> or <code>Store Items</code>.</p>
<h3 id="service-layer">Service Layer</h3>
<p>Services are modules supporting domains. Each domain can link several services to achieve desired outcomes. Such services will most likely talk to the backend, obtaining data from it, persisting the data in its storage, and exposing the data to domains.</p>
<p>A service in our theoretical e-commerce app could be a <code>Checkout Service</code>. This service would handle all of the necessary communication with the backend so as to proceed with the credit card payments etc.</p>
<h3 id="core-layer">Core Layer</h3>
<p>The core layer is the enabler for the whole app. Services will link the necessary modules out of it for e.g communicating with the backend or providing a general abstraction of persisting the data. Domains will link e.g UI components for easier implementation of screens and so on.</p>
<p>A core module in our e-commerce app could be <code>Network</code> or <code>UIComponents</code>.</p>
<h3 id="shared-layer">Shared Layer</h3>
<p>The shared layer is a supporting layer for the whole framework. It can happen that this layer might not need to exist, therefore, it is not considered in all diagrams. However, a perfect example of the shared layer is some logging mechanism. Even core layer modules may want to log some output and that could potentially lead to duplicates. This duplicated code could be solved by the shared layer or by following principles of clean architecture. Nevertheless, more on that topic later.</p>
<p>For example, a shared module in an e-commerce app could be <code>Logging</code> or <code>AppAnalytics</code>.</p>
<h2 id="example-international-space-station">Example: International Space Station</h2>
<p>Now in this example, we will have a look at how such architecture could look like for the <a href="https://en.wikipedia.org/wiki/International_Space_Station">International Space Station</a>. The diagram below shows the four-layer architecture with the modules and links.</p>
<p>While this chapter is rather theoretical, in the following chapters everything will be explained and showcased in practice.</p>
<figure>
<img src="assets/ISS.png" alt="Overview" /><figcaption aria-hidden="true">Overview</figcaption>
</figure>
<p>The example has three applications.</p>
<ul>
<li><code>ISS Overview</code>: app that shows astronauts the overall status of the space station</li>
<li><code>Cosmonaut</code>: app where a Cosmonaut can control his spacesuit as well as his supplies and personal information</li>
<li><code>Laboratory</code>: app from which the laboratories on the space station can be controlled</li>
</ul>
<p>As described above, all apps link the Scaffold module which provides the bootstrapping for the app while the app itself behaves like a container.</p>
<h3 id="iss-overview">ISS Overview</h3>
<figure>
<img src="assets/ISSOverview.png" alt="ISS Overview" /><figcaption aria-hidden="true">ISS Overview</figcaption>
</figure>
<p>The diagram above describes the concrete linking of modules for the app. Let us have a closer look at it.</p>
<p><code>ISS Overview</code> app links the domain <code>Peripheries</code>, which implements logic and screens for peripheries of the station.</p>
<p>The <code>Peripheries</code> domain links the <code>Heat Radiator</code>, <code>Solar Array</code>, and <code>Docking Port</code> services from which data about those peripheries are gathered so as <code>UIComponents</code> for bootstrapping the screens’ development.</p>
<p>The linked services use the <code>Network</code> and <code>Radio</code> core modules. These provide the foundation for the communication with other systems via network protocols. <code>Radio</code> in this case could implement some communication channel via BLE (Bluetooth Low Energy) or other technology which would connect to the solar array or heat radiator.</p>
<h3 id="cosmonaut">Cosmonaut</h3>
<figure>
<img src="assets/Cosmonaut.png" alt="Cosmonaut App" /><figcaption aria-hidden="true">Cosmonaut App</figcaption>
</figure>
<p>The <code>Cosmonaut</code> app links the <code>Spacesuit</code> and <code>Cosmonaut</code> domains. This is the same for every other domain, each domain is responsible for screens and users flow through the part of the app.</p>
<p><code>Spacesuit</code> and <code>Cosmonaut</code> domains link <code>Spacesuit</code> and <code>Cosmonaut</code> services that provide data for domain-specifc screens as <code>UIComponents</code> provides the UI parts.</p>
<p><code>Spacesuit</code> service is using <code>Radio</code> for communication with cosmonauts spacesuit via BLE or another type of radio technology. <code>Cosmonaut</code> service uses <code>Network</code> for updating Houston about the current state of the <code>Cosmonaut</code> and uses <code>Persistence</code> for storing the data of the cosmonaut for offline usage.</p>
<h3 id="laboratory">Laboratory</h3>
<p>I will leave this one for the reader to figure out.</p>
<h2 id="conclusion">Conclusion</h2>
<p>As you can probably imagine, scaling the architecture as described above should not be a problem. When it comes to extending the ISS Overview app for another ISS periphery, for example, a new domain module can be easily added with some service modules etc.</p>
<p>When a requirement comes for creating a new app for e.g. cosmonauts, the new app can already link the battlefield proven and tested <code>Cosmonaut</code> domain module with other necessary modules that are required. Development of the new app will thus become much easier.</p>
<p>The knowledge of the software that remains in one repository where developers have access to and can learn from is also very beneficial.</p>
<p>There are of course some disadvantages as well. For example, onboarding new developers on such an architecture might take a while, especially when there is already a huge existing codebase. In such a case, pair programming comes into play so as a proper project onboarding, software architecture document and the overall documentation of modules which helps newcomers to get on the right track.</p>
<h1 id="libraries-on-apples-ecosystem">Libraries on Apple’s ecosystem</h1>
<p>Before we deep dive into the development of previously described architecture, there is some essential knowledge that needs to be explained. In particular, we will need some background in the type of library that is going to be used for building such a project and its behaviour.</p>
<p>In Apple’s ecosystem as of today, we have two main options when it comes to creating a library. The library can either be statically or dynamically linked. Previously known as <code>Cocoa Touch Framework</code>, the dynamically linked library is nowadays referred to simply as <code>Framework</code>. The statically linked library is known as the <code>Static Library</code>.</p>
<figure>
<img src="assets/FrameworksType.png" alt="Xcode Framework Types" /><figcaption aria-hidden="true">Xcode Framework Types</figcaption>
</figure>
<p><strong>What is a library?</strong></p>
<p>To quote Apple: <em>“Libraries define symbols that are not built as part of your target.”</em></p>
<p>What are symbols? <em>Symbols reference to chunks of code or data within binary.</em></p>
<p><strong>Types of libraries:</strong></p>
<ol type="1">
<li>Dynamicaly linked</li>
</ol>
<ul>
<li><strong>Dylib</strong>: Library that has its own Mach-O (explained later) binary. (<code>.dylib</code>)</li>
<li><strong>Framework</strong>: Framework is a bundle that contains the binary and other resources the binary might need during the runtime. (<code>.framework</code>)</li>
<li><strong>TBDs</strong>: Text Based Dynamic Library Stubs is a text stubbed library (symbols only) around a binary without including it as the binary resides on the target system, used by Apple to ship lightweight SDKs for development. (<code>.tbd</code>)</li>
<li><strong>XCFramework</strong>: From Xcode 11, the XCFramework was introduced which allows grouping a set of frameworks for different platforms e.g <code>macOS</code>, <code>iOS</code>, <code>iOS simulator</code>, <code>watchOS</code> etc. (<code>.xcframework</code>)</li>
</ul>
<ol start="2" type="1">
<li>Statically linked</li>
</ol>
<ul>
<li><strong>Archive</strong>: Archive of a compiler produced object files with object code. (<code>.a</code>)</li>
<li><strong>Framework</strong>: Framework contains the static binary or static archive with additional resources the library might need. (<code>.framework</code>)</li>
<li><strong>XCFramework</strong>: Same as for dynamically linked library the XCFramework can be used with statically linked. (<code>.xcframework</code>)</li>
</ul>
<p>We can look at a framework as some bundle that is standalone and can be attached to a project with its own binary. Nevertheless, the binary cannot run by itself, it must be part of some runnable target. So what is exactly the difference?</p>
<h2 id="dynamic-vs-static-library">Dynamic vs static library?</h2>
<p>The main difference between a static and dynamic library is in the Inversion Of Control (IoC) and how they are linked towards the main executable. When you are using something from a static library, you are in control of it as it becomes part of the main executable during the build process (linking). On the other hand, when you are using something from a dynamic framework you are passing responsibility for it to the framework as the framework is dynamically linked to the executable’s process on app start. I’ll delve more into IoC in the paragraph below. Static libraries, at least on iOS, cannot contain anything other than the executable code unless they are wrapped into a static framework. A framework (dynamic or static) can contain everything you can think of e.g storyboards, XIBs, images and so on…</p>
<p>As mentioned above, the way dynamic framework code execution works is slightly different than in a classic project or a static library. For instance, calling a function from the dynamic framework is done through a framework’s interface. Let’s say a class from a framework is instantiated in the project and then a specific method is called on it. When the call is being made, you are passing the responsibility for it to the dynamic framework and the framework itself then makes sure that the specific action is executed and the results then passed back to the caller. This programming paradigm is known as Inversion Of Control. Thanks to the umbrella file and module map you know exactly what you can access and instantiate from the dynamic framework after the framework was built.</p>
<p>A dynamic framework does not support any Bridging-Header file; instead, there is an umbrella.h file. An umbrella file should contain all Objective-C imports as you would normally have in the bridging-Header file. The umbrella file is one big interface for the dynamic framework and it is usually named after the framework name e.g <code>myframework.h</code>. If you do not want to manually add all the Objective-C headers, you can just mark <code>.h</code> files as public. Xcode generates headers for ObjC for public files when building. It does the same thing for Swift files as it puts the <code>ClassName-Swift.h</code> into the umbrella file and exposes the publicly available Swift interfaces via the swiftmodule definition. You can check the final umbrella file and swiftmodule under the derived data folder of the compiled framework.</p>
<p>On the other hand, a statically linked library is attached directly to the main executable during linking as the library contains already a pre-compiled archive of the source files with symbols. That being said, there is no need for an umbrella file as is the case with IoC in a dynamic framework.</p>
<p>It goes without saying that classes and other structures must be marked as public in order to be visible outside of a framework or a library. Not surprisingly, only objects that are needed for clients of a framework or a library should be exposed.</p>
<h3 id="pros-cons">PROS &amp; CONS</h3>
<p>Now let’s have a look at some pros &amp; cons of both.</p>
<p><strong>Dynamic:</strong></p>
<ul>
<li><strong>PROS</strong>
<ul>
<li>Faster app start time as a library is linked during app launch time or runtime, therefore the main executable has lesser memory footprint to load.</li>
<li>Can be opened on demand, therefore, might not get opened at all if user do not open specific part of the app (<code>dlopen</code>).</li>
<li>Can be linked transitively to other dynamic libraries without any difficulty.</li>
<li>Can be exchanged without the recompile of the main executable just by replacing the framework with a new version.</li>
<li>Is loaded into a different memory space than the main executable.</li>
<li>Can be shared between applications especially useful for system libraries.</li>
<li>Can be loaded partially, only the needed symbols can be loaded into the memory (<code>dlsym</code>).</li>
<li>Can be loaded lazily, only objects that are referenced will be loaded.</li>
<li>Library can perform some cleanup tasks when it is closed (<code>dlclose</code>).</li>
</ul></li>
<li><strong>CONS</strong>
<ul>
<li>The target must copy all dynamic libraries else the app crashes on the start or during runtime with <code>dyld library not found</code>.</li>
<li>The overall size of the binary is bigger than the static one as the compiler can strip symbols from the static library during the compile-time while in dynamic library the symbols at least the public ones must remain.</li>
<li>Potential replacement of a dynamic library with a new version with different interfaces can break the main executable.</li>
<li>Slower library API calls as it is loaded into a different memory space and called via library interface.</li>
<li>Launch time of the app might take longer if all dynamic libraries are opened during the launch time.</li>
</ul></li>
</ul>
<p><strong>Static:</strong></p>
<ul>
<li><strong>PROS</strong>
<ul>
<li>Is part of the main executable and therefore the app cannot crash during launch or runtime due to a missing library.</li>
<li>Overall smaller size of the final executable as the unused symbols can be stripped.</li>
<li>In terms of call speed, there is no difference between the main executable and the library as the library is part of the main executable.</li>
<li>Compiler can provide some extra optimisation during the build time of the main executable.</li>
</ul></li>
<li><strong>CONS</strong>
<ul>
<li>The library must NOT be linked transitively as each link of the library would add it again. The library must be present only once in the memory either in the main executable or one of its dependencies otherwise the app will need to decide on startup which library is going to be used.</li>
<li>The main executable must be recompiled when the library has an update even though the library’s interface remains the same.</li>
<li>Memory footprint of the main executable is bigger which implies the load time of the app is slower.</li>
</ul></li>
</ul>
<h2 id="essentials">Essentials</h2>
<p>When building any kind of modular architecture, it is crucial to keep in mind that a static library is attached to the executable while a dynamic one is opened and linked at the start time. Thereafter, if there are two frameworks linking the same static library the app will launch with warnings <code>Class loaded twice ... one of them will be used.</code> issue. That causes a much slower app starts as the app needs to decide which of those classes will be used. Furthermore, when two different versions of the same static library are used the app will use them interchangeably. Debugging will become a horror in that case. That being said, it is very important to be sure that the linking was done right and no warnings appear.</p>
<p>All that is the reason why using dynamically linked frameworks for internal development is the way to go. However, working with static libraries is, unfortunately, inevitable especially when working with 3rd party libraries. Big companies like Google, Microsoft or Amazon are using static libraries for distributing their SDKs. For example: <code>GoogleMaps</code>, <code>GooglePlaces</code>, <code>Firebase</code>, <code>MSAppCenter</code> and all subsets of those SDKs are linked statically.</p>
<p>When using 3rd party dependency manager like Cocoapods for linking one static library attached to more than one project (App or Framework) it would fail the installation with <code>target has transitive dependencies that include static binaries</code>. Therefore, it takes extra effort to link static binaries into multiple frameworks.</p>
<p>Let’s have a look at how to link such a static library into a dynamically linked SDK.</p>
<h2 id="exposing-static-3rd-party-library">Exposing static 3rd party library</h2>
<p>As mentioned above, it takes extra effort to link a static library or static framework into a dynamically linked project correctly. The crucial part is to make sure that it is linked only in one place. Either it can be linked towards one dynamic framework or towards the app target. When linked toward a dynamic framework, the static library can be exposed via umbrella file and made available everywhere the framework is linked. When linked toward the app target, the static library or framework cannot be exposed anywhere else directly but can be passed through to other frameworks on the code level via some level of abstraction. The same applies to the static framework.</p>
<p>As an example of such umbrella file exposing GoogleMaps library that was linked to it could be:</p>
<pre class="objc"><code>// MyFramework.h - Umbrella file
#import &lt;UIKit/UIKit.h&gt;
#import &quot;GoogleMaps/GoogleMaps.h&quot;</code></pre>
<p>The import of the header file of <code>GoogleMaps</code> into the frameworks umbrella file exposes all public headers of the GoogleMaps because the <code>GoogleMaps.h</code> has all the GoogleMaps public headers.</p>
<pre class="objc"><code>// GoogleMaps.h
#import &quot;GMSIndoorBuilding.h&quot;
#import &quot;GMSIndoorLevel.h&quot;
#import &quot;GMSAddress.h&quot;
...</code></pre>
<p>The library becomes available as soon as the <code>MyFramework</code> import precedes the <code>GoogleMaps</code> one.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// MyFileInApp.swift</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">MyFramework</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">GoogleMaps</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span></code></pre></div>
<p>In case of the static <code>GoogleMaps</code> framework, it is necessary to copy its bundle towards the app because it is there that the <code>GoogleMaps</code> binary is looking for its resources (translations, images, and so on).</p>
<h2 id="examining-library">Examining library</h2>
<p>Let us have a look at some of the commands that comes in handy when solving some problems when it comes to compiler errors or receiving compiled closed source dynamic framework or a static library. To give it a quick start let’s have a look at a binary we all know very well; UIKit. The path to the UIKit.framework is: <code>/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/UIKit.framework</code></p>
<p>Apple ships various different tools for exploring compiled libraries and frameworks. On the UIKit framework, I will demonstrate only essential commands that I often find quite useful.</p>
<h3 id="mach-o-file-format">Mach-O file format</h3>
<p>Before we start, it is crucial to know what we are going to be exploring. In the Apple ecosystem, the file format of any binary is called Mach-O (Mach object). Mach-O has a pre-defined structure starting with Mach-O header, following by segments, sections, load commands and so on.</p>
<p>Since you are surely a curious reader, by now you have many questions about where it all comes from. The answer to that is quite simple. Since it is all part of the system, you can open up Xcode and look for a file in a global path <code>/usr/include/mach-o/loader.h</code>. In the <code>loader.h</code> file for example the Mach-O header struct is defined.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * The 64-bit mach header appears at the very beginning of object files for</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * 64-bit architectures.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> mach_header_64 <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span>    magic<span class="op">;</span>      <span class="co">/* mach magic number identifier */</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">cpu_type_t</span>  cputype<span class="op">;</span>    <span class="co">/* cpu specifier */</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">cpu_subtype_t</span>   cpusubtype<span class="op">;</span> <span class="co">/* machine specifier */</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span>    filetype<span class="op">;</span>   <span class="co">/* type of file */</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span>    ncmds<span class="op">;</span>      <span class="co">/* number of load commands */</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span>    sizeofcmds<span class="op">;</span> <span class="co">/* the size of all the load commands */</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span>    flags<span class="op">;</span>      <span class="co">/* flags */</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span>    reserved<span class="op">;</span>   <span class="co">/* reserved */</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>When the compiler produces the final executable the Mach-O header is placed at a concrete byte position in it. Therefore, tools that are working with the executables knows exactly where to look for desired information. The same principle applies to all other parts of Mach-O as well.</p>
<p>For further exploration of Mach-O file, I would recommend reading the following <a href="https://medium.com/@cyrilcermak/exploring-ios-es-mach-o-executable-structure-aa5d8d1c7103.">article</a>.</p>
<h3 id="fat-headers">Fat headers</h3>
<p>First, let’s have a look at what Architectures the binary can be linked on (fat headers). For that, we are going to use <code>otool</code>; the utility that is shipped within every macOS. To list fat headers of a compiled binary we will use the flag <code>-f</code> and to produce a symbols readable output I also added the <code>-v</code> flag.</p>
<pre class="shell"><code>otool -fv ./UIKit</code></pre>
<p>Not surprisingly, the output produces two architectures. One that runs on the Intel mac (<code>x86_64</code>) when deploying to the simulator and one that runs on iPhones as well as on the recently introduced M1 Mac (<code>arm64</code>).</p>
<pre><code>Fat headers
fat_magic FAT_MAGIC
nfat_arch 2
architecture x86_64
    cputype CPU_TYPE_X86_64
    cpusubtype CPU_SUBTYPE_X86_64_ALL
    capabilities 0x0
    offset 4096
    size 26736
    align 2^12 (4096)
architecture arm64
    cputype CPU_TYPE_ARM64
    cpusubtype CPU_SUBTYPE_ARM64_ALL
    capabilities 0x0
    offset 32768
    size 51504
    align 2^14 (16384)</code></pre>
<p>When the command finishes successfully while not printing any output it simply means that the binary does not contain the fat header. That being said, the library can run only on one architecture and to see which architecture that is, we have to print out the Mach-O header of the executable.</p>
<pre class="shell"><code>otool -hv ./UIKit</code></pre>
<p>From the output of the Mach-O header we can see that the <code>cputype</code> is <code>X86_64</code>. We can also see some extra information like with which <code>flags</code> the library was compiled, the <code>filetype</code>, and so on.</p>
<pre><code>Mach header
      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds
MH_MAGIC_64  X86_64        ALL  0x00       DYLIB    21       1400

      flags
NOUNDEFS DYLDLINK TWOLEVEL APP_EXTENSION_SAFE</code></pre>
<h3 id="executable-type">Executable type</h3>
<p>Second, let us determine what type of library we are dealing with. For that, we will use again the <code>otool</code> as mentioned above. Mach-O header specifies <code>filetype</code>. So running it again on the <code>UIKit.framework</code> with the <code>-hv</code> flags produces the following output:</p>
<pre><code>Mach header
      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds
MH_MAGIC_64  X86_64        ALL  0x00       DYLIB    21       1400

      flags
NOUNDEFS DYLDLINK TWOLEVEL APP_EXTENSION_SAFE</code></pre>
<p>From the output’s <code>filetype</code> we can see that it is a dynamically linked library. From its extension, we can say it is a dynamically linked framework. As described ealier, a framework can be dynamically or statically linked. The perfect example of a statically linked framework is <code>GoogleMaps.framework</code>. When running the same command on the binary of <code>GoogleMaps</code> from the output we can see that the binary is NOT dynamically linked as its type is <code>OBJECT</code> aka object files which means that the library is static and linked to the attached executable at the compile time.</p>
<pre><code>Mach header
      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds
MH_MAGIC_64  X86_64        ALL  0x00      OBJECT     4       2688

      flags
SUBSECTIONS_VIA_SYMBOLS</code></pre>
<p>The reason for wrapping the static library into a framework was the necessary inclusion of <code>GoogleMaps.bundle</code> which needed to be copied to the target in order for the library to work correctly with its resources.</p>
<p>Now, let’s try to run the same command on the static library archive. As an example we can use again one of the Xcode’s libraries located at <code>/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/iphoneos/libswiftCompatibility50.a</code> path. From the library extension we can immediately say the library is static. Running the <code>otool -hv libswiftCompatibility50.a</code> just confirms that the <code>filetype</code> is <code>OBJECT</code>.</p>
<pre><code>Archive : ./libswiftCompatibility50.a (architecture armv7)
Mach header
      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds
   MH_MAGIC     ARM         V7  0x00      OBJECT     4        588

     flags
SUBSECTIONS_VIA_SYMBOLS

Mach header
      magic cputype cpusubtype  caps    filetype ncmds sizeofcmds
   MH_MAGIC     ARM         V7  0x00      OBJECT     5        736

      flags
SUBSECTIONS_VIA_SYMBOLS
...</code></pre>
<p>While static library archive ending with <code>.a</code> is a clearly static one with a framework to be sure that the library is dynamically linked it is necessary to check the binary for its <code>filetype</code> in the Mach-O header.</p>
<h3 id="dependencies">Dependencies</h3>
<p>Third, let’s have a look at what the library is linking. For that the <code>otool</code> provides <code>-L</code> flag.</p>
<pre class="shell"><code>otool -L ./UIKit</code></pre>
<p>The output lists all dependencies of the UIKit framework. For example, here you can see that UIKit is linking <code>Foundation</code>. That’s why the <code>import Foundation</code> is no longer needed when importing <code>UIKit</code> into a source code file.</p>
<pre><code>./UIKit:
/System/Library/Frameworks/UIKit.framework/UIKit ...
/System/Library/Frameworks/FileProvider.framework/FileProvider ...
/System/Library/Frameworks/Foundation.framework/Foundation ...
/System/Library/PrivateFrameworks/DocumentManager.framework/DocumentManager ...
/System/Library/PrivateFrameworks/UIKitCore.framework/UIKitCore ...
/System/Library/PrivateFrameworks/ShareSheet.framework/ShareSheet ...
/usr/lib/libobjc.A.dylib ...
/usr/lib/libSystem.B.dylib ...</code></pre>
<h3 id="symbols-table">Symbols table</h3>
<p>Fourth, it is also useful to know which symbols are defined in the framework. For that, the <code>nm</code> utility is available. To print all symbols including the debugging ones I added <code>-a</code> flag as well as <code>-C</code> to print them demangled. Name mangling is a technique of adding extra information about the language data type (class, struct, enum …) to the symbol during compile time in order to pass more information about it to the linker. With a mangled symbol, the linker will know that this symbols is for a class, getter, setter etc and can work with it accordingly.</p>
<pre class="shell"><code>nm -Ca ./UIKit</code></pre>
<p>Unfortunately, the output here is very limited as those symbols listed are the ones that define the dynamic framework itself. The limitation is because Apple ships the binary obfuscated and when reverse-engineering the binary with for example Radare2 disassembler, all we can see is a couple of <code>add byte</code> assembly instructions. It is still possible to dump the list of symbols, but for that we would have to either use <code>lldb</code> and have the UIKit framework loaded in the memory space or dump the memory footprint of the framework and explore it decrypted. That is unfortunately not part of this book.</p>
<pre><code>0000000000000ff0 s _UIKitVersionNumber
0000000000000fc0 s _UIKitVersionString
                 U dyld_stub_binder</code></pre>
<p>Just to give an example of how the symbols would look, I printed out compiled realm framework by running <code>nm -Ca ./Realm</code>.</p>
<pre><code>...
2c4650 T realm::Table::do_move_row(unsigned long, unsigned long)
2cb1e8 T realm::Table::do_set_link(unsigned long, unsigned long, unsigned long)
4305e0 S realm::Table::max_integer
4305e8 S realm::Table::min_integer
2c44b4 T realm::Table::do_swap_rows(unsigned long, unsigned long)
2ce9bc T realm::Table::find_all_int(unsigned long, long long)
2cb3ac T realm::Table::get_linklist(unsigned long, unsigned long)
2c4d64 T realm::Table::set_subtable(unsigned long, unsigned long, realm::Table const*)
2bd9f8 T realm::Table::create_column(realm::ColumnType, unsigned long, bool, realm::Allocator&amp;)
2bf3fc T realm::Table::discard_views()
...</code></pre>
<p>It seems like Realm was developed in C++ but it can be clearly seen what kind of symbols are available within the binary. Let us look at one more example but for Swift with Alamofire. There we can, unfortunately, see that the <code>nm</code> was not able to demangle the symbols.</p>
<pre><code>...
34d00 T _$s9Alamofire7RequestC8delegateAA12TaskDelegateCvM
34dc0 T _$s9Alamofire7RequestC4taskSo16NSURLSessionTaskCSgvg
34e20 T _$s9Alamofire7RequestC7sessionSo12NSURLSessionCvg
34e50 T _$s9Alamofire7RequestC7request10Foundation10URLRequestVSgvg
350c0 T _$s9Alamofire7RequestC8responseSo17NSHTTPURLResponseCSgvg
351e0 T _$s9Alamofire7RequestC10retryCountSuvpfi
...</code></pre>
<p>To demangle swift manually following command can be used.</p>
<pre class="shell"><code>nm -a ./Alamofire | awk &#39;{ print $3 }&#39; | xargs swift demangle {} \;</code></pre>
<p>Which produces the mangled symbol name with the demangled explanation.</p>
<pre><code>...
_$s9Alamofire7RequestC4taskSo16NSURLSessionTaskCSgvg
  ---&gt; Alamofire.Request.task.getter : __C.NSURLSessionTask?
_$s9Alamofire7RequestC4taskSo16NSURLSessionTaskCSgvgTq
  ---&gt; method descriptor for Alamofire.Request.task.getter : __C.NSURLSessionTask?
_$s9Alamofire7RequestC10retryCountSuvpfi
  ---&gt; variable initialization expression of Alamofire.Request.retryCount : Swift.UInt
...</code></pre>
<h3 id="strings">Strings</h3>
<p>Last but not least, it can be also helpful to list all strings that the binary contains. That could help catch developers’ mistakes such as not obfuscated secrets and some other strings that should not be part of the binary. To do that we will use <code>strings</code> utility again on the Alamofire binary.</p>
<pre class="shell"><code>strings ./Alamofire</code></pre>
<p>The output is a list of plain text strings found in the binary.</p>
<pre><code>...
Could not fetch the file size from the provided URL:
The URL provided is a directory:
The system returned an error while checking the provided URL for
reachability.
URL:
The URL provided is not reachable:
...</code></pre>
<h2 id="build-system">Build system</h2>
<p>The last piece of information that is missing now is how it all gets glued together. As Apple developers, we are using Xcode for developing apps for Apple products that are then distributed via App Store or other distribution channels. Xcode under the hood is using <code>Xcode Build System</code> for producing final executables that run on <code>X86</code> and <code>ARM</code> processor architectures.</p>
<p>The Xcode build system consists of multiple steps that depend on each other. Xcode build system supports C based languages (C, C++, Objective-C, Objective-C++) compiled with <code>clang</code> as well as Swift language compiled with <code>swiftc</code>.</p>
<p>Let’s have a quick look at what Xcode does when the build is triggered.</p>
<ol type="1">
<li><strong>Preprocessing</strong></li>
</ol>
<p>Preprocessing resolves macros, removes comments, imports files and so on. In a nutshell, it prepares the code for the compiler. The preprocessor also decides which compiler will be used for which source code file. Not surprisingly, Swift source code file will be compiled by <code>swiftc</code> and other C like files will use <code>clang</code>.</p>
<ol start="2" type="1">
<li><strong>Compiler</strong> (<code>swiftc</code>, <code>clang</code>)</li>
</ol>
<p>As mentioned above, the Xcode build system uses two compilers; clang and swiftc. The compiler consists of two parts, front-end and back-end. Both compilers use the same back-end, LLVM (Low-Level Virtual Machine) and language-specific front-end. The job of a compiler is to compile the post-processed source code files into object files that contain object code. Object code is simply human-readable assembly instructions that can be understood by the CPU.</p>
<ol start="3" type="1">
<li><strong>Assembler</strong> (<code>asm</code>)</li>
</ol>
<p>The assembler takes the output of the compiler (assembly) and produces relocatable machine code. Machine code is recognised by a concrete type of processor (ARM, X86). The opposite of relocatable machine code would be absolute machine code. While relocatable code can be placed at any position in memory by loader the absolute machine code has its position set in the binary.</p>
<ol start="4" type="1">
<li><strong>Linker</strong> (<code>ld</code>)</li>
</ol>
<p>The final step of the build system is linking. The linker is a program that takes object files (multiple compiled files) and links (merges) them together based on the symbols those files are using as well as static and dynamic libraries as needed. In order to be able to link libraries the linker needs to know the paths where to look for them. Linker produces the final single file; Mach-O executable.</p>
<ol start="5" type="1">
<li><strong>Loader</strong> (<code>loader</code>)</li>
</ol>
<p>After the executable was built, the job of a loader is to bring the executable into memory and start the program execution. Loader is a system program operating on the kernel level. Loader assigns the memory space and loads Mach-O executable to it.</p>
<p>Now you should have a high-level overview of what phases the Xcode build system goes through when the build is started.</p>
<h2 id="conclusion-1">Conclusion</h2>
<p>I hope this chapter provided a clear understanding of the essential differences between static and dynamic libraries as well as provided some clear examples showing to examine them. It was quite a lot to grasp, so now it’s time for a double shot of espresso or any kind of preferable refreshment.</p>
<p>I would highly recommend to deep dive into this topic even more. Here are some resources I would recommend;</p>
<p><a href="https://medium.com/@cyrilcermak/exploring-ios-es-mach-o-executable-structure-aa5d8d1c7103">Exploring iOS-es Mach-O Executable Structure</a></p>
<p><a href="https://pewpewthespells.com/blog/static_and_dynamic_libraries.html">Static and Dynamic Libraries</a></p>
<p><a href="https://stackoverflow.com/questions/15331056/library-static-dynamic-or-framework-project-inside-another-project">Difference in between static and dynamic library from our beloved StackOverflow</a></p>
<p><a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/000-Introduction/Introduction.html#//apple_ref/doc/uid/TP40001908-SW1">Dynamic Library Programming Topics</a></p>
<p><a href="https://medium.com/flawless-app-stories/xcode-build-system-know-it-better-96936e7f52a">Xcode Build System : Know it better</a></p>
<p><a href="https://www.objc.io/issues/6-build-tools/mach-o-executables/">Mach-O Executables</a></p>
<p><a href="https://llvm.org/">LLVM website</a></p>
<p><a href="https://developer.apple.com/videos/play/wwdc2018/415/">Behind the Scenes of the Xcode Build Process</a></p>
<p><a href="https://developer.apple.com/videos/play/wwdc2018/408/">Building Faster in Xcode</a></p>
<p>Used binaries:</p>
<p><a href="https://developers.google.com/maps/documentation/ios-sdk/v3-client-migration#install-manually">GoogleMaps</a></p>
<p><a href="https://github.com/Alamofire/Alamofire">Alamofire</a></p>
<p><a href="https://realm.io/docs/swift/latest">Realm</a></p>
<h1 id="swift-compiler-optional">Swift Compiler (optional)</h1>
<p>Since we touched the Xcode’s build system in the previous chapter it would be unfair to the <code>swiftc</code> to leave it untouched. Even though knowing how compiler works is not mandatory knowledge it is really interesting and it gives a good closure of the whole process from writing human-readable code to running it on bare metal.</p>
<p>While other chapters are rather essential for having a good understanding of the development of modular architecture, this chapter is optional.</p>
<h2 id="compiler-architecture">Compiler Architecture</h2>
<p>To fully understand swift’s compiler architecture and its process, let us have a look at the documentation provided by <a href="https://swift.org/swift-compiler/#compiler-architecture">swift.org</a> and do some practical examples based on it.</p>
<p>The following image describes the <code>swiftc</code> architecture. It consists of seven steps, which are explained in subchapters.</p>
<figure>
<img src="assets/swiftc_arch.png" alt="Swiftc Architecture" /><figcaption aria-hidden="true">Swiftc Architecture</figcaption>
</figure>
<p>For demonstration purposes, I prepared two simple swift source code files. First, <code>employee.swift</code> and second <code>main.swift</code>. The file <code>employee.swift</code> is standalone source code while <code>main.swift</code> requires the Employee being linked to it as a library. All compiler steps are explained on the <code>employee.swift</code> but in the end, the employee source code will be created as a library that the main file will consume and use.</p>
<p><code>employee.swift</code></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">Foundation</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> Address <span class="op">{</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">houseNo</span><span class="op">:</span> Int <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">street</span><span class="op">:</span> String <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">city</span><span class="op">:</span> String <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">state</span><span class="op">:</span> String <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> Person <span class="op">{</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">firstName</span><span class="op">:</span> String <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">lastName</span><span class="op">:</span> String <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">address</span><span class="op">:</span> Address <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Employee<span class="op">:</span> <span class="dt">Person</span> <span class="op">{</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">let</span> <span class="va">firstName</span><span class="op">:</span> String</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">let</span> <span class="va">lastName</span><span class="op">:</span> String</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">let</span> <span class="va">address</span><span class="op">:</span> Address</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">init</span><span class="op">(</span>firstName<span class="op">:</span> String<span class="op">,</span> lastName<span class="op">:</span> String<span class="op">,</span> address<span class="op">:</span> Address<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>firstName <span class="op">=</span> firstName</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>lastName <span class="op">=</span> lastName</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>address <span class="op">=</span> address</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">func</span> <span class="fu">printEmployeeInfo</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">firstName) </span><span class="er">\(</span><span class="st">lastName)&quot;</span><span class="op">)</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">address.houseNo). </span><span class="er">\(</span><span class="st">address.street), </span><span class="er">\(</span><span class="st">address.city), </span><span class="er">\(</span><span class="st">address.state)&quot;</span><span class="op">)</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">struct</span> EmployeeAddress<span class="op">:</span> <span class="dt">Address</span> <span class="op">{</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">let</span> <span class="va">houseNo</span><span class="op">:</span> Int</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">let</span> <span class="va">street</span><span class="op">:</span> String</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">let</span> <span class="va">city</span><span class="op">:</span> String</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">let</span> <span class="va">state</span><span class="op">:</span> String</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">init</span><span class="op">(</span>houseNo<span class="op">:</span> Int<span class="op">,</span> street<span class="op">:</span> String<span class="op">,</span> city<span class="op">:</span> String<span class="op">,</span> state<span class="op">:</span> String<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>houseNo <span class="op">=</span> houseNo</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>street <span class="op">=</span> street</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>city <span class="op">=</span> city</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>state <span class="op">=</span> state</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>main.swift</code></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">Foundation</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">Employee</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">employee</span> <span class="op">=</span> Employee<span class="op">(</span>firstName<span class="op">:</span> <span class="st">&quot;Cyril&quot;</span><span class="op">,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                       lastName<span class="op">:</span> <span class="st">&quot;Cermak&quot;</span><span class="op">,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                       address<span class="op">:</span> EmployeeAddress<span class="op">(</span>houseNo<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> street<span class="op">:</span> <span class="st">&quot;PorschePlatz&quot;</span><span class="op">,</span> city<span class="op">:</span> <span class="st">&quot;Stuttgart&quot;</span><span class="op">,</span> state<span class="op">:</span> <span class="st">&quot;Germany&quot;</span><span class="op">))</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>employee<span class="op">.</span>printEmployeeInfo<span class="op">()</span></span></code></pre></div>
<h3 id="parsing">Parsing</h3>
<blockquote>
<p>The parser is a simple, recursive-descent parser (implemented in lib/Parse) with an integrated, hand-coded lexer. The parser is responsible for generating an Abstract Syntax Tree (AST) without any semantic or type information, and emit warnings or errors for grammatical problems with the input source.</p>
</blockquote>
<p>Source: <a href="https://swift.org/swift-compiler/#compiler-architecture">swift.org</a></p>
<p>First in the compilation process is <strong>parsing</strong>. As the definition says, the parser is responsible for the lexical syntax check without any type check. The following command prints the parsed AST.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">swiftc</span> ./employee.swift <span class="at">-dump-parse</span></span></code></pre></div>
<p>In the output, you can notice that the types are not resolved and end with errors.</p>
<pre><code>(source_file &quot;./employee.swift&quot;
// Importing Foundation
  (import_decl range=[./employee.swift:1:1 - line:1:8] &#39;Foundation&#39;)
// Address protocol declaration
  (protocol range=[./employee.swift:3:8 - line:8:1] &quot;Address&quot; &lt;Self : Address&gt; requirement signature=&lt;null&gt;
    (pattern_binding_decl range=[./employee.swift:4:5 - line:4:28]
      (pattern_typed
        (pattern_named &#39;houseNo&#39;)
        (type_ident
          (component id=&#39;Int&#39; bind=none))))
// houseNo variable declaration
    (var_decl range=[./employee.swift:4:9 - line:4:9] &quot;houseNo&quot; type=&#39;&lt;null type&gt;&#39; readImpl=getter immutable
      (accessor_decl range=[./employee.swift:4:24 - line:4:24] &#39;anonname=0x7fc1e408db80&#39; get_for=houseNo
// Not recognized Int type
        (parameter &quot;self&quot;./employee.swift:4:18: error: cannot find type &#39;Int&#39; in scope
    var houseNo: Int { get }
                 ^~~
)
...
// Employee class declaration
(class_decl range=[./employee.swift:16:8 - line:31:1] &quot;Employee&quot; inherits: &lt;null&gt;
    (pattern_binding_decl range=[./employee.swift:17:12 - line:17:27]
      (pattern_typed
        (pattern_named &#39;firstName&#39;)
        (type_ident
          (component id=&#39;String&#39; bind=none))))
// Employee class vars declaration
    (var_decl range=[./employee.swift:17:16 - line:17:16] &quot;firstName&quot; type=&#39;&lt;null type&gt;&#39; let readImpl=stored immutable)
    (pattern_binding_decl range=[./employee.swift:18:12 - line:18:26]
      (pattern_typed
        (pattern_named &#39;lastName&#39;)
        (type_ident
          (component id=&#39;String&#39; bind=none))))
...</code></pre>
<p>From the parsed AST we can see that it is really descriptive. The source code of <code>employee.swift</code> has 47 lines of code while its parsed AST without type check has 270.</p>
<p>Out of curiosity, let us have a look at how the tree would look with a syntax error. To do so, I added the winner of all times in hide and seek, a semi-colon <code>;</code>, to the protocol declaration.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> Address <span class="op">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">houseNo</span><span class="op">:</span> Int<span class="op">;</span> <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span></code></pre></div>
<p>After running the same command we can see a syntax error at the declaration of <code>houseNo</code> variable. That is the error Xcode would show as soon as it type checks the source file.</p>
<pre><code>...
(var_decl range=[./employee.swift:4:9 - line:4:9] &quot;houseNo&quot; type=&#39;&lt;null type&gt;&#39;./employee.swift:4:9: error: property in protocol must have explicit { get } or { get set } specifier
    var houseNo: Int; { get }
...</code></pre>
<h3 id="semantic-analysis">Semantic analysis</h3>
<blockquote>
<p>Semantic analysis (implemented in lib/Sema) is responsible for taking the parsed AST and transforming it into a well-formed, fully-type-checked form of the AST, emitting warnings or errors for semantic problems in the source code. Semantic analysis includes type inference and, on success, indicates that it is safe to generate code from the resulting, type-checked AST.</p>
</blockquote>
<p>Source: <a href="https://swift.org/swift-compiler/#compiler-architecture">swift.org</a></p>
<p>After parsing, comes the <strong>semantic analysis</strong>. From its definition, we should see fully type-checked parsed AST. Executing the following command will give us the answer.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">swiftc</span> ./employee.swift <span class="at">-dump-ast</span></span></code></pre></div>
<p>In the output all types are resolved and recognised by the compiler and the errors no longer appear.</p>
<pre><code>// Address protocol with resolved types
(protocol range=[./employee.swift:3:8 - line:8:1] &quot;Address&quot; &lt;Self : Address&gt; interface type=&#39;Address.Protocol&#39; access=public non-resilient requirement signature=&lt;Self&gt;
   (pattern_binding_decl range=[./employee.swift:4:5 - line:4:18] trailing_semi
     (pattern_typed type=&#39;Int&#39;
       (pattern_named type=&#39;Int&#39; &#39;houseNo&#39;)
       (type_ident
         (component id=&#39;Int&#39; bind=Swift.(file).Int))))
...
// EmployeeAddress conforming to the Address protocol
(struct_decl range=[./employee.swift:33:8 - line:45:1] &quot;EmployeeAddress&quot; interface type=&#39;EmployeeAddress.Type&#39; access=public non-resilient inherits: Address
   (pattern_binding_decl range=[./employee.swift:34:12 - line:34:25]
     (pattern_typed type=&#39;Int&#39;
       (pattern_named type=&#39;Int&#39; &#39;houseNo&#39;)
       (type_ident
         (component id=&#39;Int&#39; bind=Swift.(file).Int))))
// Variable declaration on EmployeeAddress
   (var_decl range=[./employee.swift:34:16 - line:34:16] &quot;houseNo&quot; type=&#39;Int&#39; interface type=&#39;Int&#39; access=public let readImpl=stored immutable
     (accessor_decl implicit range=[./employee.swift:34:16 - line:34:16] &#39;anonname=0x7fd2821409e8&#39; interface type=&#39;(EmployeeAddress) -&gt; () -&gt; Int&#39; access=public get_for=houseNo
       (parameter &quot;self&quot; type=&#39;EmployeeAddress&#39; interface type=&#39;EmployeeAddress&#39;)
       (parameter_list)
       (brace_stmt implicit range=[./employee.swift:34:16 - line:34:16]
         (return_stmt implicit
           (member_ref_expr implicit type=&#39;Int&#39; decl=employee.(file).EmployeeAddress.houseNo@./employee.swift:34:16 direct_to_storage
             (declref_expr implicit type=&#39;EmployeeAddress&#39; decl=employee.(file).EmployeeAddress.&lt;anonymous&gt;.self@./employee.swift:34:16 function_ref=unapplied))))))</code></pre>
<p>Not surprisingly, when using an unknown type, the command results in an error.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> Address <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">houseNo</span><span class="op">:</span> Foo <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span></code></pre></div>
<pre><code>/employee.swift:4:18: error: cannot find type &#39;Foo&#39; in scope
    var houseNo: Foo { get }
                 ^~~
(source_file &quot;./employee.swift&quot;
  (import_decl range=[./employee.swift:1:1 - line:1:8] &#39;Foundation&#39;)
  (protocol range=[./employee.swift:3:8 - line:8:1] &quot;Address&quot; &lt;Self : Address&gt; interface type=&#39;Address.Protocol&#39; access=public non-resilient requirement signature=&lt;Self&gt;
    (pattern_binding_decl range=[./employee.swift:4:5 - line:4:28]
      (pattern_typed type=&#39;&lt;&lt;error type&gt;&gt;&#39;</code></pre>
<h3 id="clang-importer">Clang importer</h3>
<blockquote>
<p>The Clang importer (implemented in lib/ClangImporter imports Clang modules and maps the C or Objective-C APIs they export into their corresponding Swift APIs. The resulting imported ASTs can be referred to by semantic analysis.</p>
</blockquote>
<p>Source: <a href="https://swift.org/swift-compiler/#compiler-architecture">swift.org</a></p>
<p>The third in the compilation process is the <strong>clang importer</strong>. This is the well-known bridging of C/ObjC languages to the Swift API’s and wise versa.</p>
<h3 id="sil-generation">SIL generation</h3>
<blockquote>
<p>The Swift Intermediate Language (SIL) is a high-level, Swift-specific intermediate language suitable for further analysis and optimization of Swift code. The SIL generation phase (implemented in lib/SILGen) lowers the type-checked AST into so-called “raw” SIL. The design of SIL is described in docs/SIL.rst.</p>
</blockquote>
<p>Source: <a href="https://swift.org/swift-compiler/#compiler-architecture">swift.org</a></p>
<p>The fourth step in the compilation process is the <strong>Swift Intermediate Language</strong>. Are you curious about how it looks? To print it, we can use the following command.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">swiftc</span> ./employee.swift <span class="at">-emit-sil</span></span></code></pre></div>
<p>In the output, we can see the <code>witness tables</code>, <code>vtables</code> and <code>message dispatch</code> tables alongside with other intermediate declarations. Unfortunately, an explanation of this is out of the scope of this book. More about these topics can be obtained in the article about <a href="https://www.rightpoint.com/rplabs/switch-method-dispatch-table">method dispatch</a>.</p>
<pre><code>...
// protocol witness for Address.state.getter in conformance EmployeeAddress
sil shared [transparent] [serialized] [thunk] @$s8employee15EmployeeAddressVAA0C0A2aDP5stateSSvgTW : $@convention(witness_method: Address) (@in_guaranteed EmployeeAddress) -&gt; @owned String {
// %0                                             // user: %1
bb0(%0 : $*EmployeeAddress):
  %1 = load %0 : $*EmployeeAddress                // user: %3
  // function_ref EmployeeAddress.state.getter
  %2 = function_ref @$s8employee15EmployeeAddressV5stateSSvg : $@convention(method) (@guaranteed EmployeeAddress) -&gt; @owned String // user: %3
  %3 = apply %2(%1) : $@convention(method) (@guaranteed EmployeeAddress) -&gt; @owned String // user: %4
  return %3 : $String                             // id: %4
} // end sil function &#39;$s8employee15EmployeeAddressVAA0C0A2aDP5stateSSvgTW&#39;

sil_vtable [serialized] Employee {
  #Employee.init!allocator: (Employee.Type) -&gt; (String, String, Address) -&gt; Employee : @$s8employee8EmployeeC9firstName04lastD07addressACSS_SSAA7Address_ptcfC  // Employee.__allocating_init(firstName:lastName:address:)
  #Employee.printEmployeeInfo: (Employee) -&gt; () -&gt; () : @$s8employee8EmployeeC05printB4InfoyyF  // Employee.printEmployeeInfo()
  #Employee.deinit!deallocator: @$s8employee8EmployeeCfD    // Employee.__deallocating_deinit
}

sil_witness_table [serialized] Employee: Person module employee {
  method #Person.firstName!getter: &lt;Self where Self : Person&gt; (Self) -&gt; () -&gt; String : @$s8employee8EmployeeCAA6PersonA2aDP9firstNameSSvgTW // protocol witness for Person.firstName.getter in conformance Employee
  method #Person.lastName!getter: &lt;Self where Self : Person&gt; (Self) -&gt; () -&gt; String : @$s8employee8EmployeeCAA6PersonA2aDP8lastNameSSvgTW   // protocol witness for Person.lastName.getter in conformance Employee
  method #Person.address!getter: &lt;Self where Self : Person&gt; (Self) -&gt; () -&gt; Address : @$s8employee8EmployeeCAA6PersonA2aDP7addressAA7Address_pvgTW  // protocol witness for Person.address.getter in conformance Employee
}

sil_witness_table [serialized] EmployeeAddress: Address module employee {
  method #Address.houseNo!getter: &lt;Self where Self : Address&gt; (Self) -&gt; () -&gt; Int : @$s8employee15EmployeeAddressVAA0C0A2aDP7houseNoSivgTW  // protocol witness for Address.houseNo.getter in conformance EmployeeAddress
  method #Address.street!getter: &lt;Self where Self : Address&gt; (Self) -&gt; () -&gt; String : @$s8employee15EmployeeAddressVAA0C0A2aDP6streetSSvgTW // protocol witness for Address.street.getter in conformance EmployeeAddress
  method #Address.city!getter: &lt;Self where Self : Address&gt; (Self) -&gt; () -&gt; String : @$s8employee15EmployeeAddressVAA0C0A2aDP4citySSvgTW // protocol witness for Address.city.getter in conformance EmployeeAddress
  method #Address.state!getter: &lt;Self where Self : Address&gt; (Self) -&gt; () -&gt; String : @$s8employee15EmployeeAddressVAA0C0A2aDP5stateSSvgTW   // protocol witness for Address.state.getter in conformance EmployeeAddress
}
...</code></pre>
<p>Furthermore, the SIL must go through next two phases; guaranteed transformation and optimisation.</p>
<blockquote>
<p>SIL guaranteed transformations: The SIL guaranteed transformations (implemented in lib/SILOptimizer/Mandatory) perform additional dataflow diagnostics that affect the correctness of a program (such as a use of uninitialized variables). The end result of these transformations is “canonical” SIL.</p>
</blockquote>
<p>Source: <a href="https://swift.org/swift-compiler/#compiler-architecture">swift.org</a></p>
<blockquote>
<p>SIL Optimizations: The SIL optimizations (implemented in lib/Analysis, lib/ARC, lib/LoopTransforms, and lib/Transforms) perform additional high-level, Swift-specific optimizations to the program, including (for example) Automatic Reference Counting optimizations, devirtualization, and generic specialization.</p>
</blockquote>
<p>Source: <a href="https://swift.org/swift-compiler/#compiler-architecture">swift.org</a></p>
<h3 id="llvm-ir-generation">LLVM IR Generation</h3>
<blockquote>
<p>IR generation (implemented in lib/IRGen) lowers SIL to LLVM IR, at which point LLVM can continue to optimize it and generate machine code.</p>
</blockquote>
<p>Source: <a href="https://swift.org/swift-compiler/#compiler-architecture">swift.org</a></p>
<p>The final step in the compilation process is that of the IR (Intermediate Representation) for LLVM. To get the IR from the swiftc we can use the following command:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">swiftc</span> ./employee.swift <span class="at">-emit-ir</span> <span class="kw">|</span> <span class="fu">more</span></span></code></pre></div>
<p>Here we can see a snippet of the LLVM’s familiar code declaration. In the next step, the code would be transformed by LLVM into the machine code.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">entry:</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>   %1 = getelementptr inbounds <span class="op">%</span>__opaque_existential_type_1<span class="op">,</span> <span class="op">%</span>__opaque_existential_type_1<span class="op">*</span> <span class="op">%</span><span class="dv">0</span><span class="op">,</span> i32 <span class="dv">0</span><span class="op">,</span> i32 <span class="dv">1</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>   %2 = <span class="bu">load</span> <span class="op">%</span>swift<span class="op">.</span>type<span class="op">*,</span> <span class="op">%</span>swift<span class="op">.</span>type<span class="op">**</span> <span class="op">%</span><span class="dv">1</span><span class="op">,</span> align <span class="dv">8</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>   %3 = getelementptr inbounds <span class="op">%</span>__opaque_existential_type_1<span class="op">,</span> <span class="op">%</span>__opaque_existential_type_1<span class="op">*</span> <span class="op">%</span><span class="dv">0</span><span class="op">,</span> i32 <span class="dv">0</span><span class="op">,</span> i32 <span class="dv">0</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>   %4 = bitcast <span class="op">%</span>swift<span class="op">.</span>type<span class="op">*</span> <span class="op">%</span><span class="dv">2</span> to i8<span class="op">***</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>   %5 = getelementptr inbounds i8<span class="op">**,</span> i8<span class="op">***</span> <span class="op">%</span><span class="dv">4</span><span class="op">,</span> i64 <span class="op">-</span><span class="dv">1</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>   %.valueWitnesses <span class="op">=</span> load i8<span class="op">**,</span> i8<span class="op">***</span> <span class="op">%</span><span class="dv">5</span><span class="op">,</span> align <span class="dv">8</span><span class="op">,</span> <span class="op">!</span>invariant<span class="op">.</span>load <span class="op">!</span><span class="dv">64</span><span class="op">,</span> <span class="op">!</span>dereferenceable <span class="op">!</span><span class="dv">65</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>   %6 = bitcast i8<span class="op">**</span> <span class="op">%.</span>valueWitnesses to <span class="op">%</span>swift<span class="op">.</span>vwtable<span class="op">*</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>   %7 = getelementptr inbounds <span class="op">%</span>swift<span class="op">.</span>vwtable<span class="op">,</span> <span class="op">%</span>swift<span class="op">.</span>vwtable<span class="op">*</span> <span class="op">%</span><span class="dv">6</span><span class="op">,</span> i32 <span class="dv">0</span><span class="op">,</span> i32 <span class="dv">10</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>   %flags <span class="op">=</span> load i32<span class="op">,</span> i32<span class="op">*</span> <span class="op">%</span><span class="dv">7</span><span class="op">,</span> align <span class="dv">8</span><span class="op">,</span> <span class="op">!</span>invariant<span class="op">.</span>load <span class="op">!</span><span class="dv">64</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>   %8 = <span class="bu">and</span> i32 <span class="op">%</span>flags<span class="op">,</span> <span class="dv">131072</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>   %flags<span class="op">.</span>isInline <span class="op">=</span> icmp eq i32 <span class="op">%</span><span class="dv">8</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>   br i1 <span class="op">%</span>flags<span class="op">.</span>isInline<span class="op">,</span> label <span class="op">%</span>inline<span class="op">,</span> label <span class="op">%</span>outline</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<h3 id="exporting-dylib">Exporting dylib</h3>
<p>Finally, we can explore how to manually create a library out of the source code and link it towards the executable.</p>
<p>The following command will export the <code>employee.swift</code> file as an <code>Employee.dylib</code> with its module definition. Instead of using the parameter <code>-emit-module</code> we could use <code>-emit-object</code> to obtain a statically linked library.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">swiftc</span> ./employee.swift <span class="at">-emit-library</span> <span class="at">-emit-module</span> <span class="at">-parse-as-library</span> <span class="at">-module-name</span> Employee</span></code></pre></div>
<p>After executing the command, the following files should be created.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">380B</span> Apr  2 13:36 Employee.swiftdoc</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">19K</span> Apr  3 20:52 Employee.swiftmodule</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2.9K</span> Apr  3 20:52 Employee.swiftsourceinfo</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="ex">1.1K</span> Apr  3 20:52 employee.swift</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">57K</span> Apr  3 20:52 libEmployee.dylib</span></code></pre></div>
<p>Now we can import the Employee library into the <code>main.swift</code> file and proceed with the compile. However, here we have to tell the compiler and linker where to find the Employee library. In this example, I placed the library into a directory named <em>Frameworks</em> which resides on the same level as the <code>main.swift</code>.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">swiftc</span> main.swift <span class="at">-emit-executable</span> <span class="at">-lEmployee</span> <span class="at">-I</span> ./Frameworks <span class="at">-L</span> ./Frameworks</span></code></pre></div>
<p>To give it a bit more explanation the command <code>swiftc -h</code> desribes those flags as follows:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-emit-executable</span>        Emit a linked executable</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-I</span> <span class="op">&lt;</span>value<span class="op">&gt;</span>              Add directory to the import search path</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="ex">-L</span> <span class="op">&lt;</span>value<span class="op">&gt;</span>              Add directory to library link search path</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-l</span><span class="op">&lt;</span>value<span class="op">&gt;</span>               Specifies a library which should be linked against</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
<p>Hurrray, the executable was created with the linked library! Unfortunately, it crashes right on start with the following:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dyld:</span> Library not loaded: libEmployee.dylib</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Referenced</span> from: /Users/cyrilcermak/Programming/iOS/modular_architecture_on_ios/example/./main</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Reason:</span> image not found</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[1]</span>    92481 abort      ./main</span></code></pre></div>
<p>Using the knowledge from the previous chapter we can check where the binary expects the library to be with the command <code>otool -l ./main</code>.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Load</span> command 15</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>          <span class="ex">cmd</span> LC_LOAD_DYLIB</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>      <span class="ex">cmdsize</span> 48</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>         <span class="ex">name</span> libEmployee.dylib <span class="er">(</span><span class="ex">offset</span> 24<span class="kw">)</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>   <span class="bu">time</span> stamp 2 Thu Jan  1 01:00:02 1970</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>      <span class="ex">current</span> version 0.0.0</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="ex">compatibility</span> version 0.0.0</span></code></pre></div>
<p>The binary expects the libEmployee.dylib to be at the same path. This can be easily fixed with one more tool, <code>install_name</code>. It changes the path to the linked library in the main executable. It can be used as follows;</p>
<pre><code>install_name_tool -change libEmployee.dylib @executable_path/Frameworks/libEmployee.dylib main</code></pre>
<p>Running it again prints the desired output:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Cyril</span> Cermak</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="ex">1.</span> PorschePlatz, Stuttgart, Germany</span></code></pre></div>
<h2 id="conclusion-2">Conclusion</h2>
<p>In this chapter, the basics of Swift compiler architecture were explored. I hope this (optional) chapter gave a high-level overview and brought more curiosity into the topic of how compilers work. For more study I would refer to the following sources:</p>
<p><a href="https://swift.org/swift-compiler/#compiler-architecture">Swift Compiler</a></p>
<p><a href="https://developer.apple.com/videos/play/wwdc2016/416/">Understanding Swift Performance</a></p>
<p><a href="https://heartbeat.fritz.ai/understanding-method-dispatch-in-swift-684801e718bc">Understanding method dispatch in Swift</a></p>
<p><a href="https://www.rightpoint.com/rplabs/switch-method-dispatch-table">Method Dispatch in Swift</a></p>
<p><a href="https://modocache.io/getting-started-with-swift-development">Getting Started with Swift Compiler Development</a></p>
<p><a href="https://wincent.com/wiki/%40executable_path%2C_%40load_path_and_%40rpath">executable path, load path and rpath</a></p>
<h1 id="development-of-the-modular-architecture">Development of the modular architecture</h1>
<p>The necessary theory about Apple’s libraries and some essentials were explained. Finally, it is time to deep dive into the building phase.</p>
<p>First, let us do it manually and automate the process of creating libraries later on so that the newcomers do not have to copy-paste much of the boilerplate code when starting a new team or new part of the framework.</p>
<p>For demonstration purposes, I chose the Cosmonaut app with all its necessary dependencies. Nevertheless, the same principle applies to all other apps within our future iOS/macOS ISS foundational framework.</p>
<p>You can download the <a href="https://github.com/CyrilCermak/modular-architecture-on-iOS">pre-build repository</a> and fully focus on the step by step explanations in the book or you can build it on your own up until a certain point.</p>
<p>As a reminder, the following schema showcases the Cosmonaut app with its dependencies.</p>
<div style="float:center" data-markdown="1">
<figure>
<img src="assets/Cosmonaut.png" style="width:70.0%" alt="Cosmonaut App" /><figcaption aria-hidden="true">Cosmonaut App</figcaption>
</figure>
</div>
<h2 id="creating-workspace-structure">Creating workspace structure</h2>
<p>First, let us manually create the Cosmonaut app from Xcode under the <code>iss_application_framework/app/</code> directory. To achieve that, simply create a new App from the Xcode’s menu and save it under the predefined folder path with the <code>Cosmonaut</code> name. An empty project app should be created, you can run it if you want. Nevertheless, for our purposes, the project structure is not optimal. We will be working in a workspace that will contain multiple projects (apps and frameworks).</p>
<div style="float:center" data-markdown="1">
<figure>
<img src="assets/xcode_create_app.png" style="width:80.0%" alt="Create New App" /><figcaption aria-hidden="true">Create New App</figcaption>
</figure>
</div>
<p>Since we do not have <code>Cocopods</code> yet, which would convert the project into a workspace, we have to do it manually. In Xcode under <code>File</code>, select the option <code>Save As Workspace</code>. Close the project and open the Workspace that was newly created by Xcode. So far the workspace contains only the App. Now it is time to create the necessary dependencies for the Cosmonaut app.</p>
<p>Going top-down through the diagram first comes the <code>Domain</code> layer where <code>Spacesuit</code>, <code>Cosmonaut</code> and <code>Scaffold</code> is needed to be created. For creating the <code>Spacesuit</code> let us use Xcode one last time. Under the new project select the framework icon, name it <code>Cosmonaut</code> and save it under the <code>iss_application_framework/domain/</code> directory.</p>
<div style="float:center" data-markdown="1">
<figure>
<img src="assets/xcode_create_framework.png" style="width:80.0%" alt="Create New Framework" /><figcaption aria-hidden="true">Create New Framework</figcaption>
</figure>
</div>
<h3 id="automating-the-process">Automating the process</h3>
<p>While creating new frameworks and apps is not a daily business, the process still needs to assure that correct namespaces and conventions are used across the whole application framework. This usually leads to copy-pasting an existing framework or app to create a new one with the same patterns. Now is a good time to create the first script that will support the development of the application framework.</p>
<p>If you are building the application framework from scratch please copy the <code>{PROJECT_ROOT}/fastlane</code> directory from the repository into your <code>root</code> directory.</p>
<p>The scripting around the framework with <code>Fastlane</code> is explained later on in the book. However, all you need to know now is that Fastlane contains lane <code>make_new_project</code> that takes three arguments; <code>type</code> {app|framework}, <code>project_name</code> and <code>destination_path</code>. The lane in Fastlane simple uses the instance of the <code>ProjectFactory</code> class located in the <code>{PROJECT_ROOT}/fastlane/scripts/ProjectFactory/project_factory.rb</code> file.</p>
<p>The <code>ProjectFactory</code> creates a new framework or app based on the <code>type</code> parameter that is passed to it from the command line. As an example of creating the Spacesuit domain framework, the following command can be used.</p>
<pre class="shell"><code>fastlane make_new_project type:framework project_name:Spacesuit destination_path:../domain/Spacesuit</code></pre>
<p>In case of Fastlane not being installed on your Mac, you can install it via <code>brew install fastlane</code> or later on via Ruby <code>gems</code> defined in <code>Gemfile</code>. For installation please follow the official <a href="https://docs.fastlane.tools/getting-started/ios/setup/">manual</a>.</p>
<p>Furthermore, now that we have the script, all the remaining dependencies can be created with it.</p>
<p>The overall ISS Application Framework should look as follows:</p>
<figure>
<img src="assets/tree_framework.png" style="width:50.0%" alt="Tree structre" /><figcaption aria-hidden="true">Tree structre</figcaption>
</figure>
<p>Each directory contains an Xcode project which is either a framework or an app created by the script. From now on, every onboarded team or developer should use the script when adding a framework or an app.</p>
<h3 id="xcodes-workspace">Xcode’s workspace</h3>
<p>Last but not least, let us create the same directory structure in Xcode’s Workspace so that we can, later on, link those frameworks together and towards the app. The workspace <code>Cosmonaut.xcworkspace</code> resides in the folder Cosmonaut under the app folder. An <code>xcworkspace</code> is simply a structure that contains:</p>
<ul>
<li><code>xcshareddata</code>: Directory that contains schemes, breakpoints and other shared information</li>
<li><code>xcuserdata</code>: Directory that contains information about the current users interface state, opened/modified files of the user and so on</li>
<li><code>contents.xcworkspacedata</code>: An XML file that describes what projects are linked towards the workspace such that Xcode can understand it</li>
</ul>
<p>The workspace structure can be created either by drag and drop all necessary framework projects for the <code>Cosmonaut</code> app or by directly modifying the <code>contents.xcworkspacedata</code> XML file. No matter which way was chosen the final <code>xcworkspace</code> should look as follow:</p>
<figure>
<img src="assets/xcode_workspace.png" alt="Workspace strucutre" /><figcaption aria-hidden="true">Workspace strucutre</figcaption>
</figure>
<h2 id="generating-projects">Generating projects</h2>
<p>You might have noticed <code>project.yml</code> file that was created with every framework or app. This file is used by <code>XcodeGen</code> (will be introduced in a second) to generate the project based on the settings described in the yaml file. This will avoid conflicts in Apple’s infamous <code>project.pbxproj</code> files that represent each project. In modular architecture, this is particularly useful as we are working with many projects across the workspace.</p>
<p>Conflicts in the <code>project.pbxproj</code> files are very common when more than one developer is working on the same codebase. Besides the build settings for the project, this file contains and tracks files that are included for the compilation. It also tracks the targets to which these files belong. A typical conflict happens when one developer removes a file from the Xcode’s structure while another developer was modifying it in a separate branch. This will resolve in a merge conflict in the <code>pbxproj</code> file which is very time consuming to fix as the file is using Apple’s mystified language no one can understand.</p>
<p>Since programmers are lazy creatures, it very often also happens that a file removed from an Xcode project still remains in the repository as the file itself was not moved to the trash. That could lead to git continuing to track a now unused and undesired file. Furthermore, it could also lead to the file being readded to the project by the developer who was modifying it.</p>
<h3 id="hello-xcodegen">Hello XcodeGen</h3>
<p>Fortunately, in the Apple ecosystem, we can use <a href="https://github.com/yonaskolb/XcodeGen">xcodegen</a>, a program that generates the <code>pbxproj</code> file for us based on the well-arranged yaml file. In order to use it, we have to first install it via <code>brew install xcodegen</code> or via other ways described on its homepage.</p>
<p>As an example, let us have a look at the Cosmonaut app project.yml.</p>
<p><code>app/Cosmonaut/project.yml</code></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import of the main build_settings file</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span><span class="kw">:</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> ../../fastlane/build_settings.yml</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition of the project</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Cosmonaut</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="fu">settings</span><span class="kw">:</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">groups</span><span class="kw">:</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> BuildSettings</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition of the targets that exists within the project</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="fu">targets</span><span class="kw">:</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co">  # The main application</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Cosmonaut</span><span class="kw">:</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> application</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">platform</span><span class="kw">:</span><span class="at"> iOS</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">sources</span><span class="kw">:</span><span class="at"> Cosmonaut</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="co">      # Domains</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSCosmonaut.framework</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSSpacesuit.framework</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSScaffold.framework</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a><span class="co">      # Services</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSSpacesuitService.framework</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSCosmonautService.framework</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a><span class="co">      # Core</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSNetwork.framework</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSRadio.framework</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSPersistence.framework</span></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSUIComponents.framework</span></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a><span class="co">  # Tests for the main application</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">CosmonautTests</span><span class="kw">:</span></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> bundle.unit-test</span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">platform</span><span class="kw">:</span><span class="at"> iOS</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">sources</span><span class="kw">:</span><span class="at"> CosmonautTests</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">target</span><span class="kw">:</span><span class="at"> Cosmonaut</span></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">settings</span><span class="kw">:</span></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">TEST_HOST</span><span class="kw">:</span><span class="at"> $(BUILT_PRODUCTS_DIR)/Cosmonaut.app/Cosmonaut</span></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a><span class="co">  # UITests for the main application</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">CosmonautUITests</span><span class="kw">:</span></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> bundle.ui-testing</span></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">platform</span><span class="kw">:</span><span class="at"> iOS</span></span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">sources</span><span class="kw">:</span><span class="at"> CosmonautUITests</span></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">target</span><span class="kw">:</span><span class="at"> Cosmonaut</span></span></code></pre></div>
<p>Even though the YAML file speaks for itself, let me explain some of it.</p>
<p>First of all, let us look at the <code>include</code> in the very beginning.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import of the main build_settings file</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span><span class="kw">:</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> ../../fastlane/build_settings.yml</span></span></code></pre></div>
<p>Before xcodegen starts generating the pbxproj project it processes and includes other YAML files if the include keyword is found. In case of the application framework, this is extremely helpful as the build settings for each project can be described just by one YAML file.</p>
<p>Imagine a scenario where the iOS deployment version must be bumped up for the app. Since the app links also many frameworks which are being compiled before the app, their deployment target also needs to be bumped up. Without XcodeGen, each project would have to be modified to have the new deployment target. Even worse, when trying some build settings out instead of modifying it on each project a simple change in one file that is included in the others will do the trick.</p>
<p>A simplified build settings YAML file could look like this:</p>
<p><code>fastlane/build_settings.yml</code></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span><span class="kw">:</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">bundleIdPrefix</span><span class="kw">:</span><span class="at"> com.iss</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">developmentLanguage</span><span class="kw">:</span><span class="at"> en</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">settingGroups</span><span class="kw">:</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">BuildSettings</span><span class="kw">:</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">base</span><span class="kw">:</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">    # Architectures</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">SDKROOT</span><span class="kw">:</span><span class="at"> iphoneos</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">    # Build Options</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES</span><span class="kw">:</span><span class="at"> $(inherited)</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DEBUG_INFORMATION_FORMAT</span><span class="kw">:</span><span class="at"> dwarf-with-dsym</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ENABLE_BITCODE</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">    # Deployment</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">IPHONEOS_DEPLOYMENT_TARGET</span><span class="kw">:</span><span class="at"> </span><span class="fl">13.0</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">TARGETED_DEVICE_FAMILY</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">...</span></span></code></pre></div>
<p>Worth mentioning is that in the <code>BuildSettings</code> the key in the YAML matches with Xcode build settings which can be seen in the inspector side panel. As you can see the <code>BuildSettings</code> key is then referred inside the <code>project.yml</code> file under the settings right after the project name.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Cosmonaut</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">settings</span><span class="kw">:</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">groups</span><span class="kw">:</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> BuildSettings</span></span></code></pre></div>
<p>The following key is <code>targets</code>. In the case of the Cosmonaut application, we are setting three targets. One for the app itself, one for unit tests and finally one for UI tests. Each key sets the name of the target and then describes it with <code>type</code>, <code>platform</code>, <code>dependencies</code> and other parameters XcodeGen supports.</p>
<p>Next, let us have a look at the dependencies:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co">  # Domains</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSCosmonaut.framework</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSSpacesuit.framework</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSScaffold.framework</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co">...</span></span></code></pre></div>
<p>The dependencies section links the specified frameworks toward the app. On the snippet above, you can see which dependencies the app is using. The <code>implicit</code> keyword with the framework means that the framework is not pre-compiled and requires compilation to be found. That being said, the framework needs to be part of the workspace in order for the build system to work. Another parameter that can be stated there is <code>embeded: {true|false}</code>. This parameter sets whether the framework will be embedded with the app and copied into the target. By default XcodeGen has <code>embeded: true</code> for applications as they have to copy the compiled framework to the target in order for the app to launch successfully and <code>embeded: false</code> for frameworks. Since the framework is not a standalone executable and must be part of some application it is expected that the application copies it.</p>
<p>Full documentation of XcodeGen can be found on its GitHub <a href="https://github.com/yonaskolb/XcodeGen">page</a>:</p>
<p>Finally, let’s generate the projects and build the app with all its frameworks. For that, a simple lane in Fastlane was created.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>lane <span class="wa">:generate</span> <span class="cf">do</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Finding all projects within directories</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Dir</span><span class="kw">[</span><span class="st">&quot;../**/project.yml&quot;</span><span class="kw">]</span><span class="at">.each</span> <span class="cf">do</span> <span class="kw">|</span>project_path<span class="kw">|</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skipping the template files</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span> <span class="cf">if</span> project_path<span class="at">.include?</span> <span class="st">&quot;fastlane&quot;</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="cn">UI</span><span class="at">.success</span> <span class="st">&quot;Generating project: </span><span class="sc">#{</span>project_path<span class="sc">}</span><span class="st">&quot;</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="in">`xcodegen -s </span><span class="sc">#{</span>project_path<span class="sc">}</span><span class="in">`</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Simply executing the <code>fastlane generate</code> command in the root directory of the application framework generates all projects and we can open the workspace and press run. The output of the command should look as follows:</p>
<figure>
<img src="assets/fastlane_generate.png" alt="fastlane generate output" /><figcaption aria-hidden="true">fastlane generate output</figcaption>
</figure>
<h2 id="ground-rules">Ground Rules</h2>
<p>Looking at the ISS architecture, two very important patterns are being followed.</p>
<p>First of all, any framework does NOT allow linking modules on the same layer. Doing so is meant to prevent creating cross-linking cycles in between frameworks. For example, if the Network module would link Radio module and the Radio module would link Network module we would be in serious trouble. Surprisingly, Xcode does not fail to build every time in such a setup. However, it will have a really hard time with compiling and linking, up until one day it starts failing.</p>
<p>Second of all, each layer can link frameworks only from its sublayer. This ensures the vertical linking pattern. That being said, the cross-linking dependencies will also not happen on the vertical level.</p>
<p>Let us have a look at some examples of cross-linking dependencies.</p>
<h3 id="cross-linking-dependencies">Cross-linking dependencies</h3>
<p>Let us say that the build system will jump on compiling the Network module where the Radio is being linked to. When it comes to the point where the Radio needs to be linked it jumps to compile the Radio module without finishing the compilation of the Network. The Radio module now requires a Network module to continue compiling, however, the Network module has not finished compiling yet, therefore, no <code>swiftmodule</code> and other files were yet created. The compiler will continue compiling up until one file will be referencing some part (e.g a class in a file) of the other module and the other module will be referencing the caller.</p>
<p>That’s where the compiler will stop.</p>
<p>Needless to say, each layer is defined to contain stand-alone modules that are just in need of some sub-dependencies. In theory this is all nice and makes sense. In practice, however, it can happen that one domain will require something from another domain (for example, the Cosmonaut domain will require something from the Spacesuit domain). It can be some domain-specific logic, views or even the whole flow of screens. In that case, there are some options for how to tackle the issue. Either, a new module on the service layer can be created and the necessary source code files that are shared across multiple domains being moved there. Another option is to shift those files from the domain layer to the service layer. A third option would be to use abstraction and achieve the same result not from the module level but from the code level. The ideal solution solely depends on the use case.</p>
<p>A simple example could be that some flow is represented by a protocol that has a <code>start</code> function on it. That could for example be a <code>coordinator</code> pattern that would be defined for the whole framework and all modules would be following it. That protocol must then be defined in one of the lower layers frameworks in this case since it is related to a flow of view controllers, the UIComponents could be a good place for it. Due to that, in the framework, we can rely on all domains understanding it. Thereafter, the Cosmonaut app could instantiate the coordinator from the Spacesuit domain and pass it down or assign it as a child coordinator to the Cosmonaut domain.</p>
<h3 id="vertical-linking">Vertical linking</h3>
<p>As with horizontal layer linking, vertical linking is also very important and must be followed to avoid the aforementioned compiler issues. In practice, such a scenario can also happen very easily. Imagine, that your team designed a new framework on the Core layer that will provide some extended logging functionality and some data analytics. After a while, some team will want to use the logging functionality, for example in the Radio module, to provide more debugging details for developers for the Bluetooth module.</p>
<p>Unlike in the cross-linking dependencies scenario, in this case, the abstraction was defined on the core level already. Thereafter, there is no way of passing it in the code from the top down. In this case, the new layer needs to be created, let us say shared or common. The supporting layer will contain mostly some shared functionality for the Core layer as well as some protocols that would allow passing references from the top down.</p>
<p>Another solution would be to separate the core public protocols and models of the framework such that the framework can be exposed and linked towards more frameworks on the same layer. On the higher level, the instantiation would take place and the instances would be passed to the implementations on the lower layer as they both linked towards the newly created core framework of that module. This, however, has the downside of having an extra framework that needs to be linked and maintained. However, with this approach, the so-called <code>Clean Architecture</code> would be followed. More about that later.</p>
<p>Needless to say, any higher-level layer framework can link any framework from any lower layer. So for example, the Cosmonaut app can link anything from the Core or the newly defined Shared layer.</p>
<h2 id="app-secrets">App secrets</h2>
<p>Project secrets could be API keys, SDK keys, encryption keys, as well as configuration files or certificates containing sensitive information that could cause potential harm to the app. Considering, many developers are working in the same repository on the same project, keeping project secrets stored securely such that they are exposed only to appropriate developers can be challenging. Essentially, any piece of sensitive information should not be exposed to anyone not working directly on the project. By any means, secrets should NOT be stored in the repository and should not be part of the compiled binary as plain strings.</p>
<p>The app ideally should decrypt encrypted secret during its runtime. Even though, on a jailbroken iPhone the potential attacker could gain runtime access and print out the secrets while debugging or bypass SSLPinning and sniff the secrets from the network. Considering, the SSLPinning was in a place like it should. In any case, it will take much more effort than just dumping binary strings that contain secrets.</p>
<p>About two years ago me and my colleague Jörg Nestele had a look at the problem and over few weekends we came out with an open-source project written purely in Ruby called Mobile Secrets which solves this problem in a Swifty way.</p>
<p>Now, let us have a look at how to handle secrets in the project.</p>
<h3 id="how-to-handle-secrets">How to handle secrets</h3>
<p>First thing first, as mentioned above any secret must be obfuscated, without a doubt. String obfuscation is a technique that via XOR, AES or other encryption algorithms modifies the confidential string or a file such that it cannot be de-obfuscated without the initial encryption key.</p>
<p>Unfortunately, obfuscating strings or files and committing them to the repository might not be enough. What if there is a colleague who has access to the source repository or someone who might want to steal these secrets and hand them out? Simply downloading the repository and printing the de-obfuscated string into a console would do it.</p>
<p>Essentially, the secret should be visible only for the right developer in any circumstances. Especially, for mono-repository projects where many teams are contributing simultaneously. That is where GPG comes into play.</p>
<h3 id="the-gnupg-gpg">The GnuPG (GPG)</h3>
<p>GPG is an asymmetric key management system that creates a hash for encryption from the public keys of all participants. In the initialisation process, GPG will generate a private and public key. The public key is saved in the <code>.gpg</code> folder under the user’s email visible to everyone. The private key is saved in <code>~/.gnupg</code> and is protected by a password chosen by the user.</p>
<p>To instal GPG on the mac, following command can be used: <code>brew install gnupg</code> and <code>gem install dotgpg</code> to install <code>dotgpg</code>, Ruby program that simplifies the usage of GPG.</p>
<p>To add a developer into the authorised group, the developer needs to provide a public key from his machine, simply executing <code>dotgpg key</code> will print the key. This key must then be added by the already authorised person <code>via dotgpg add</code>.</p>
<p>The file encrypted by GPG containing all project secrets can be then thoughtfully committed to the repository since only authorised developers who possess the private key can decrypt it.</p>
<h3 id="gem-mobile-secrets">GEM: Mobile Secrets</h3>
<p><a href="https://github.com/CyrilCermak/mobile-secrets">Mobile Secrets</a> gem uses an XOR cipher alongside with GPG to handle the whole process. To install MobileSecrets simply execute <code>gem install mobile-secrets</code>.</p>
<p>Mobile Secrets itself can then initialise the GPG for the current project if it has not been done yet by running: <code>mobile-secrets --init-gpg .</code>.</p>
<p>When GPG is initialised, a template YAML file can be created by running: <code>mobile-secrets --create-template</code>.</p>
<figure>
<img src="assets/mobile_secrets_yaml.png" alt="MobileSecrets.yml" /><figcaption aria-hidden="true">MobileSecrets.yml</figcaption>
</figure>
<p>The <code>MobileSecrets.yml</code> file contains the hash key used for obfuscation of secrets with the key-value dictionary of secrets that must be adjusted to the project needs. All secrets of the project including the initial hashing key are then being organised in this structure encrypted by GPG. When everything was edited simply import the configuration file by running the command.</p>
<p><code>mobile-secrets --import ./MobileSecrets.yml</code> and it will be stored under <code>secrets.gpg</code>.</p>
<p>Finally, we can run: <code>mobile-secrets --export ./Output/Path/</code> to export the swift file with obfuscated secrets.</p>
<p>Mobile Secrets exported Swift source code will look like the example below. Last but not least, the path to this file must be added to the <code>.gitignore</code>. The secrets source code must be generated locally alongside with generating the projects.</p>
<figure>
<img src="assets/mobile_secrets_final.png" alt="Exported Swift secrets source file" /><figcaption aria-hidden="true">Exported Swift secrets source file</figcaption>
</figure>
<h3 id="the-ugly-and-brilliant-part-of-the-secrets-source-code">The ugly and brilliant part of the Secrets source code</h3>
<p>What happened under the hood of the mobile-secrets? Out of the YAML configuration, secrets were obfuscated with the specified hash key via XOR and converted into bytes. Therefore, it ended up with an array of UInt8 arrays.</p>
<p>The first item in the bytes array is the hash key. The second item is the key for a secret, the third item contains the obfuscated secret, the fourth is again the key and fifth is the value, and so forth.</p>
<p>To get the de-obfuscated key just call the <code>string(forKey key: String)</code> function. It will iterate over the bytes array, convert the bytes into a string and comparing it with the given key. If the key was found, the decrypt function will be called with a value on the next index.</p>
<p>Since we have the array of UInt8 arrays(<code>[[UInt8]]</code>) mixed with the hash key, keys and obfuscated secrets, it would take a significant effort to reverse-engineer the binary and get the algorithm. Even to get the bytes array of arrays would take a significant effort. Doing so also made it hard to get the secrets out of the binary. Yet, the secrets can still be obtained when the attacker gains control over the runtime of the app like mentioned before.</p>
<h2 id="workflow">Workflow</h2>
<p>While this book is mostly focused on the development aspects of modular architecture, some management essentials must also be mentioned. Not surprisingly, developing software for a large organisation can be a real challenge. Imagine a scenario where around 30 to 50 developers per platform (iOS/Android/Backend) are working on the same project toward the same goal. Those developers are usually divided into multiple cross-functional teams that are working independently as toward each team’s own goals.</p>
<p>A cross-functional team usually consists of a product owner or a product manager, designers, who are defining the UI/UX and behaviour on each platform, developers from each platform, and last but not least, the quality assurance. Obviously the particular combination is highly dependent upon the company and its structure as well as the agile methodologies the company is using.</p>
<p>For example, the team goal can be developing some specific business domain where the team then becomes the domain expert and is further responsible for developing, improving, and integrating that domain into the final customer-facing application.</p>
<p>It could also be that the team develops a standalone application on top of the framework. If the team followed the same patterns defined in the framework, usually by technical leads. The app can be then easily later on integrated as a part of some bigger application that for example groups those functionalities in one app. Or the other way around splits one big app into multiple smaller ones. Like for example, Facebook did with their Messenger app.</p>
<h3 id="teams">Teams</h3>
<p>Teams and their management play a crucial role in the success of the project. The modular architecture by any means helps define boundaries of teams. From the developers POV, each developer is responsible for developing the frameworks belonging to the team. In our Cosmonaut example, it could be the Cosmonaut domain alongside with Cosmonaut service. While Spacesuit domain and Spacesuit service would be developed by another team.</p>
<p>That does not necessarily mean that the team Cosmonaut, let us say, cannot develop or modify the source code in the domain or service of Spacesuit. It should however mean that changes team Cosmonaut makes to team Spacesuit’s domain code should seek review and approval from the Spacesuit team.</p>
<p>Luckily, there is one simple solution supported by many CI/CD platforms for it: code owners. The code owner file simply defines who is the owner of which part of the codebase. This already briefly touched the topic of git which is covered in the following subchapter.</p>
<h3 id="git-contribution">Git &amp; Contribution</h3>
<p>While there are many different approaches on how to contribute to the repository via git in our modular architecture, I find one particular the most helpful: The <a href="https://guides.github.com/introduction/flow/">GitHub flow</a>. I am sure you have heard of it at some point or if you have not you could be using it without knowing.</p>
<p>Most likely, on projects developed by a single team, the whole workflow heavily depends on the team how they will decide to contribute to the repository. Nevertheless, in the case of a team of teams, contributing to a mono-repository with the GitHub flow, coupled with the four eyes principle, is the way to go.</p>
<p>The four eyes principle simply means that in order to merge a pull request, the pull request must first be reviewed by another set of eyes, another person. That being said, in the team, each platform must have at least two developers so that the team can develop autonomy and work independently.</p>
<p>When making changes in another team’s code, a dedicated code owner from the team must approve the changes. Once approved, the team can stay ahead and maintain the overview of its part of the codebase and domain knowledge. Without defining the code owners early on in the project’s lifetime, everyone would be working everywhere and it could all turn into chaos.</p>
<p>Looking at the framework structure, it is quite clear where each team has its boundaries. However, there is one part that is very difficult to maintain and takes the most effort. That part will be the core layer. While the core layer could be developed by the creators of the application framework in the very early stages, it is surely the part everybody is relying on. Therefore, great test coverage plays a crucial role when developing anything in the core layer. Later on, any change in any interface of an object will affect everybody who is using it. Since it is the lowest layer (since we are not counting the utils layer), it will be highly likely that it will be used by many frameworks in the higher layers.</p>
<p>After all the desired functionality has been implemented and known bugs have been fixed, the core layer will not need much of a focus. However, teams may still need to extend the functionality on that layer. This could result in those teams opening a PR with their needed functionality or with suggestions of improvements. In this case, the tech leads should be seen as being code owners of the code in question since they are the ones with the duty of maintaining the overall vision of the project.</p>
<h3 id="scalability">Scalability</h3>
<p>As mentioned already in the book, modular architecture is designed to be highly scalable. With the pre-defined scripts, the new team can simply create a new framework or app and start the implementation right away. Nevertheless, the onboarding of a new colleague or the whole team takes time which needs to be considered by the project management.</p>
<p>Most likely, scaling to a 6th team working on the framework will require quite an extensive onboarding session. Due to the amount of code, design patterns, CI/CD, code style and so on, it may take a lot of time for newcomers to get the speed. In such a case, platform technical leads bring new members up to speed via pair programming, code reviews, and further onboarding up until the newcomers are familiar with the development concept, patterns, and so on.</p>
<h3 id="application-framework-distribution">Application Framework &amp; Distribution</h3>
<p>Architecture-wise, the application framework can be used as the software foundation for a company. Different products can now be easily created with the pre-built foundation which encapsulates the entire company’s knowledge in software development. Needless to say, from the engineering point of view, this is a big win for the whole company. With the application framework in hand, software engineers can provide much more accurate estimates and do so with more confidence and speed. Software engineers will be able to forecast development time and make note of the biggest risks and challenges of development.</p>
<p>Nevertheless, there are many more use cases where such an architecture would be helpful. Due to modularisation, standalone frameworks can be exported and used for development without affecting the current development workflow. This could be particularly helpful when, for example, a subsidiary would be developing another software product. With pre-built core components, most importantly the UI part facing the customers, new products in the subsidiary can be built much faster and without gaining access to the confidential parts held in service or domain layers. However, in such case the team responsible for developing the distributed components, or let us say the SDK, will become the support team for the consumers of the SDK. In that case, a new process and workflow must be established. The responsible team could be opened to submitting bug reports and distributing the new versions of the SDK bi-weekly, or whenever it is suitable.</p>
<h2 id="common-problems">Common Problems</h2>
<p>While praising such architecture pretty much all the time, like everything, it comes with its disadvantages as well.</p>
<h3 id="maintenance">Maintenance</h3>
<p>First things first, the maintenance of the application framework can be very inefficient and difficult. The application framework will not go far without technical leads who can align the company strategy for the development of the framework and products. Thereafter, technical leads give the directions for the development technically backed up by system and solution architects. Since there can be many teams working and contributing to the repository some maintenance might be happening daily. The most affected part is probably the CI/CD chain. On the CI/CD things can break quickly, furthermore, maintenance of failing unit-tests, legacy code, supporting apps that are no longer in development etc is needed.</p>
<p>In case of the maintenance, a particular difficulty (challenge) could be maintaining apps or frameworks that are no longer in development. Let us say, an app consisting of domains and services was successfully delivered to the customers and there is no more development planned for it. This results in code that runs in production. Therefore, it is very important. Since it relies on the e.g service layer frameworks that are still in development the tests will start failing. Interfaces need to be updated and so on. In the end, this will require additional effort for one of the teams to just take care of it until a further decision is made for development. Another approach would be to archive it, remove it from the actively developed codebase and when the time comes, put it back. Furthermore, update all interfaces and changes that happened in the framework and then happily continue the development.</p>
<h3 id="code-style">Code style</h3>
<p>Since many different developers are working together, collaborating on the same code base, following the same code style, principles and patterns can be a challenge. Everybody has different preferences and different experiences. Getting people on the same board can sometimes be quite difficult.</p>
<p>Nevertheless, following the ground rules and overall framework patterns is what matters the most. In this case, what helps is having the code itself and framework being well documented. Good documentation should be complemented by a proper onboarding process that ideally consists of pair programming, code reviews, and ad-hoc one on one sessions. Changes in the code style, importing new libraries, introducing new patterns and so on can be discussed in developers guild meetings where everybody can vote for what seems to be the best option. In guilds, everybody can make suggestions for improvements and vote for changes he or she likes.</p>
<h3 id="not-fully-autonomous-teams">Not fully autonomous teams</h3>
<p>In theory, each team should have its own autonomy. Nevertheless, in practice it can be slightly more complicated. In some cases, teams might depend upon each other. If so, challenges of increased inter team collaboration and increased team communication may need to be addressed. Without adequately dealing with these circumstances, a worst case may be teams failing to meet their goals due to unfulfilled promises of the dependent team.</p>
<p>As more teams become increasingly dependent on one another, more meetings and alignments are needed. The increase in these syncs can, unfortunately, slows down the teams.</p>
<h3 id="conclusion-3">Conclusion</h3>
<p>In this chapter, we had a look at how the development of modular architecture could look in practice. We explored ground rules, generated projects with XcodeGen, securely handled secrets, and addressed some common problems people working on such projects will be facing.</p>
<p>I hope it all provided a good understanding of how to work in such a setup.</p>
<h1 id="dependency-managers">Dependency Managers</h1>
<p>Generally, a good practice when working on large codebases is not to import many 3rd party libraries, especially the huge ones, for example, RxSwift, Alamofire, Moja, etc. Those libraries are extraordinarily big and it is highly likely that some of their functionality will never be used. This will result in having dead code attached to the project. Needless to say, the binary size, compilation time, and, most importantly, the maintenance will increase heavily. With each API change of the library every part of the codebase will have to be adapted. Obviously, essential vendor SDKs, like GoogleMaps, Firebase, AmazonSDK and so on will still have to be linked to the project. However, using libraries to provide wrappers around the native iOS code should be avoided and instead libraries should be developed specifically to the project’s needs.</p>
<p>In one of the projects I worked on, the compile time of the whole application was at about 20-25 minutes. The project had been in development for about 8 years and had approximately 80 3rd party dependencies linked via Cocoapods. This alone accounted for the largest percentage of build time. I do remember that I spent nearly three full months refactoring the huge codebase into the modular architecture described here. Before the transformation, the project was modularised with internally developed pods. While refactoring, I also removed some of the unused libraries. Furthermore, and most importantly, I removed Alamofire, RxSwift, RxCocoa, and other big libraries from being included via Cocoapods and linked them via Carthage instead. This change decreased the compile time drastically.</p>
<p>Cocoapods libraries are compiled every time the project is cleaned while Carthage is compiled only once. Carthage produces binaries that are then linked to a project. Cleaning a project was a pretty common thing to do, and Xcode has improved in that sense a lot, but with the first Swift versions it was nowhere near perfection and with a clean build most issues disappeared immediately. After the refactoring, the compile time after cleaning the project was decreased to 10 minutes. Most of this time was the compilation of the project source code and the few 3rd party libraries that remained linked via Cocoapods for convenience.</p>
<p>The way third party libraries are managed and linked to the project matters a lot, especially, when the project is big or is aiming to be big. Now let us have a look at the three most commonly used dependency managers when developing for iOS and how to use them in modular architecture. They are as follows: Cocoapods, Carthage, and Apple’s new Swift Package Manager.</p>
<h2 id="cocoapods">Cocoapods</h2>
<p>The most used and well-known dependency manager on iOS are <a href="https://cocoapods.org/">Cocoapods</a>. Cocoapods are great to start with, it is really easy to integrate a new library so as to remove it. Cocoapods manage everything for the developer under the hood, therefore, there is no further work required to start using the library. When Cocoapods are installed, with <code>pod install</code>, they are attached to the workspace as an Xcode project that contains all libraries that are specified in the Podfile. During the compilation of the project, dependencies are compiled as they are needed. This is good for small projects, or even big ones, but the libraries must be linked carefully as every library takes some time to compile and eventually requires maintenance, like mentioned earlier.</p>
<p>Quite often Cocoapods are also used for in-house framework development which is very convenient. However, all the fun stops when the project grows and the internal dependencies are using many big libraries. Then the whole project depends on the in-house developed pods which are internally linking the 3rd party pods. This scenario can easily result in a very long compilation phase as there is no legit way of replacing the linked 3rd party frameworks via their compiled versions. It goes without saying then that Cocoapods also will not let you integrate a static library to more than one framework because of transitive dependencies. Therefore some dynamic library wrappers might need to be introduced to avoid it.</p>
<p>In such cases, it might be necessary to move away from internally developed Cocoapods and integrate a similar approach like described in this book which gives the project complete freedom. This could lead to days or even weeks of work, depending on how big and how well structured the project is. Nevertheless, moving away from such a design will improve the everyday compile time for each developer. Like mentioned before, for small projects it could really be the way to go but it has its limits.</p>
<h3 id="integration-with-the-application-framework">Integration with the application framework</h3>
<p>Surprisingly, integrating Cocoapods in the whole application framework might not be as easy as you might think. Cocoapods must keep the same versions of libraries across all frameworks and on each app developed upon those frameworks. This will require a little bit of Ruby programming. Essentially, the application framework must have one shared <code>Podfile</code> that will define pods for each framework. Thereafter, every app can easily reuse it. Furthermore, each app has its own <code>Podfile</code> that specifies which pods must be installed for which framework to avoid unnecessarily linking frameworks the app will not need.</p>
<p>Let us have a look now how the app’s <code>Podfile</code> could look for the Cosmonaut example. <code>app/Cosmonaut/Podifle</code></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Including the shared podfile</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require_relative</span> <span class="st">&quot;../../fastlane/Podfile&quot;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>platform <span class="wa">:ios</span>, <span class="vs">&#39;13.0&#39;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>workspace <span class="vs">&#39;CosmonautApp&#39;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Linking pods for desired frameworks from the shared Podfile</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Domain</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>spacesuit_sdk</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>cosmonaut_sdk</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>scaffold_sdk</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Service</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>spacesuitservice_sdk</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>cosmonautservice_sdk</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Core</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>network_sdk</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>radio_sdk</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>uicomponents_sdk</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>persistence_sdk</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Installing pods for the Application target</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>target <span class="vs">&#39;CosmonautApp&#39;</span> <span class="cf">do</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>  use_frameworks!</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  pod <span class="va">$snapKit</span><span class="at">.name</span>, <span class="va">$snapKit</span><span class="at">.version</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linking all dynamic libraries required from any used framework towards the main app target</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as only app can copy frameworks to the target</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>  add_linked_libs_from_sdks_to_app</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Dedicated tests for the application</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  target <span class="vs">&#39;CosmonautAppTests&#39;</span> <span class="cf">do</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>    inherit! <span class="wa">:search_paths</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>  target <span class="vs">&#39;CosmonautAppUITests&#39;</span> <span class="cf">do</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pods for testing</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Firstly, the shared <code>Podfile</code> that defines pods for all frameworks is included. After setting the platform and workspace, the installation for all linked frameworks takes place. Last but not least, the well known app target is defined, potentially with some extra pods. Here, special attention goes to the <code>add_linked_libs_from_sdks_to_app</code> function which will be explained in a second.</p>
<p>To fully understand what is happening inside of the app’s <code>Podfile</code> we have to have a look at the shared <code>Podfile</code>. <code>fastlane/Podifle.rb</code></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span> <span class="vs">&#39;cocoapods&#39;</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span> <span class="vs">&#39;set&#39;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="dt">Lib</span> <span class="kw">=</span> <span class="dt">Struct</span><span class="at">.new</span>(<span class="wa">:name</span>, <span class="wa">:version</span>, <span class="wa">:is_static</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="va">$linkedPods</span> <span class="kw">=</span> <span class="dt">Set</span><span class="at">.new</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">### available libraries within the whole Application Framework</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="va">$snapKit</span> <span class="kw">=</span> <span class="dt">Lib</span><span class="at">.new</span>(<span class="st">&quot;SnapKit&quot;</span>, <span class="st">&quot;5.0.0&quot;</span>)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="va">$siren</span> <span class="kw">=</span> <span class="dt">Lib</span><span class="at">.new</span>(<span class="st">&quot;Siren&quot;</span>, <span class="st">&quot;5.8.1&quot;</span>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="kw">...</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co">### Project paths with required libraries</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Domains</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="va">$scaffold_project_path</span> <span class="kw">=</span> <span class="vs">&#39;../../domain/Scaffold/Scaffold.xcodeproj&#39;</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="va">$spacesuit_project_path</span> <span class="kw">=</span> <span class="vs">&#39;../../domain/Spacesuit/Spacesuit.xcodeproj&#39;</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="kw">...</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Linked libraries</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="va">$network_libs</span> <span class="kw">=</span> <span class="kw">[</span><span class="va">$trustKit</span><span class="kw">]</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="va">$cosmonaut_libs</span> <span class="kw">=</span> <span class="kw">[</span><span class="va">$snapKit</span><span class="kw">]</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="kw">...</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="co">### Domain</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> spacesuit_sdk</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  target_name <span class="kw">=</span> <span class="vs">&#39;ISSSpacesuit&#39;</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>  install target_name, <span class="va">$spacesuit_project_path</span>, <span class="kw">[]</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> cosmonaut_sdk</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>  target_name <span class="kw">=</span> <span class="vs">&#39;ISSCosmonaut&#39;</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>  test_target_name <span class="kw">=</span> <span class="vs">&#39;CosmonautTests&#39;</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>  install target_name, <span class="va">$cosmonaut_project_path</span>, <span class="va">$cosmonaut_libs</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>  install_test_subdependencies <span class="va">$cosmonaut_project_path</span>, target_name, test_target_name, <span class="kw">[]</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="kw">...</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper wrapper around Cocoapods installation</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> install target_name, project_path, linked_libs</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>  target target_name <span class="cf">do</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>    use_frameworks!</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>    project project_path</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>    link linked_libs</span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper method to install pods that</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a><span class="co"># track the overall linked pods in the linkedPods set</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> link libs</span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>  libs<span class="at">.each</span> <span class="cf">do</span> <span class="kw">|</span>lib<span class="kw">|</span></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>    pod lib<span class="at">.name</span>, lib<span class="at">.version</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>    <span class="va">$linkedPods</span> <span class="kw">&lt;&lt;</span> lib</span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper method called from the app target to install</span></span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a><span class="co"># dynamic libraries, as they must be copied to the target</span></span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a><span class="co"># without that the app would be crashing on start</span></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> add_linked_libs_from_sdks_to_app</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>  <span class="va">$linkedPods</span><span class="at">.each</span> <span class="cf">do</span> <span class="kw">|</span>lib<span class="kw">|</span></span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span> <span class="cf">if</span> lib<span class="at">.is_static</span></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>    pod lib<span class="at">.name</span>, lib<span class="at">.version</span></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Maps the list of dependencies from YAML files to the global variables defined on top of the File</span></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g ISSUIComponents.framework found in subdependencies will get mapped to the uicomponents_libs.</span></span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a><span class="co"># From all dependencies found a Set of desired libraries is taken and installed</span></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a><span class="cf">def</span> install_test_subdependencies project_path, target_name, test_target_name, found_subdependencies</span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a>  <span class="kw">...</span></span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Here we can see, at the top of the file, the struct <code>Lib</code> that represents a Cocoapod library. In the next lines, <code>Lib</code> is used to describe the libraries that can be used within the whole framework and apps. Furthermore, each framework is defined by a function, e.g. <code>spacesuit_sdk</code>, which is then called from the main app <code>Podfile</code> to install the libraries for those required frameworks. Finally, helper functions are defined to simplify the whole workflow.</p>
<p>Those two functions require some explanation. First, the <code>add_linked_libs_from_sdks_to_app</code> mentioned in the app’s <code>Podfile</code> must be called from within the app’s target to add all the dependencies of the linked frameworks. Without it, we would end up in the so-called dependency hell. The app would be crashing with e.g <code>TrustKit library not loaded... referenced from: ISSNetwork</code>, because the libraries were linked towards the frameworks, however, frameworks do not copy linked libraries into the target. Therefore, the App must do it for us. Frameworks then can find their libraries at the <code>@rpath</code>(Runpath Search Paths).</p>
<p>The second function is <code>install_test_subdependencies</code>. This is the same scenario as for the previous function but for the tests. In order to launch tests, tests have to link all dependencies of the linked frameworks towards the XCTests. Lucky enough, thanks to Xcodegen, we can iterate over all <code>project.yml</code> files and find the linked frameworks and within the shared <code>Podfile</code> then use the defined pods for those frameworks.</p>
<p>In the source code everything is well commented so it should be easy to understand.</p>
<h2 id="carthage">Carthage</h2>
<p>While Cocoapods is a true 3rd party dependency manager that does everything for the developer under the hood, <a href="https://github.com/Carthage/Carthage">Carthage</a> leaves developers with free hands. Frameworks to be included via Carthage are listed in the <code>Cartfile</code>. Frameworks listed within this file will be fetched and either built locally or pre-compiled XCFramework will be downloaded. Executing Carthage’s build command with <code>carthage update --platform iOS</code> will fetch all the dependencies and produces the compiled versions. Such a task can be time consuming, especially, when some of the 3rd party libraries included are some of the aforementioned big ones. Nevertheless, such a command is usually executed only once. Compiled libraries can then be stored in some cloud storage where each developer or CI will pull them into the pre-defined git ignored project’s folder or possibly update them if it is necessary. That being said, a dependency maintenance and sharing strategy needs to be in place.</p>
<p>As mentioned above, Carthage only builds the libraries. Thus it is up to the developer to dictate how they are linked toward the frameworks and apps. Luckily, XcodeGen helps a lot when linking Carthage libraries. In the YAML file, it can be easily defined where the Carthage executables are stored as well as which ones we want to link. Linking a static framework can easily be performed by specifying the <code>linkType</code>.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition of the targets that exists within the project</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">targets</span><span class="kw">:</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">  # The main application</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">Cosmonaut</span><span class="kw">:</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> application</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">platform</span><span class="kw">:</span><span class="at"> iOS</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">sources</span><span class="kw">:</span><span class="at"> Cosmonaut</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co">    # Considering the Carthage is stored in the root folder of the project</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">carthageBuildPath</span><span class="kw">:</span><span class="at"> ../../Carthage/build</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">carthageExecutablePath</span><span class="kw">:</span><span class="at"> ../../Carthage</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">carthage</span><span class="kw">:</span><span class="at"> Alamofire</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">carthage</span><span class="kw">:</span><span class="at"> SnapKit</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">carthage</span><span class="kw">:</span><span class="at"> MSAppCenter</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">linkType</span><span class="kw">:</span><span class="at"> static</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co">      # Domains</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSCosmonaut.framework</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSSpacesuit.framework</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">framework</span><span class="kw">:</span><span class="at"> ISSScaffold.framework</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">implicit</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="at">    ...</span></span></code></pre></div>
<p>At build time, the compiled binaries are linked to the frameworks and apps. The expensive compile time is no longer required for each build. When the build is started, Xcode looks at the library search paths for compiled binaries to link. In comparison to compiling all 3rd party libraries from source code, linking takes only seconds.</p>
<p>By the end of the day, Carthage will require much more work in order to have it properly configured and maintained in the project. Updating one library will require recompiling the library and its dependencies, uploading it somewhere to the server where it can be accessible by all developers and, finally, downloading the latest Carthage builds by developers locally. Surely, each developer can also recompile the libraries locally but that can take away again a lot of time from each developer, depends on the amount of libraries used.</p>
<p>One last thing worth mentioning is ABI (Application Binary Interface) interoperability. Since with Carthage the binaries are being linked, the compiler must be interoperable with the compiler that produced the binaries. In the end that might be a big problem, as the whole team will have to update Xcode at the same time. Furthermore, the vendors of those libraries might need to update their source code to be compatible with the higher version of Swift. ABI is a very interesting topic in language development. I would highly encourage reading about it in the official Swift <a href="https://github.com/apple/swift/blob/main/docs/ABIStabilityManifesto.md">repository</a>.</p>
<h2 id="swiftpm">SwiftPM</h2>
<p><a href="https://swift.org/package-manager/">Swift Package Manager</a> is the official dependency manager provided by Apple. It works on a similar basis as Cocoapods. Each framework or app is described with its dependencies in a <code>Package.swift</code> file and compiled during the build. The benefit of using SwiftPM is that it can be used for script development or even cross-platform development. Cocoapods on the other hand is AppleOS dependent. Nevertheless, SwiftPM can be used for iOS/macOS development with ease. In comparison with Cocoapods, SwiftPM does not require extra actions in order to fetch the dependencies, Xcode simply takes care of it. SwiftPM also does not require using a Workspace for development as it directly adds the dependencies to the current Xcode project. In contrast, Cocopods requires working with an Xcode Workspace as the Pods are attached as a standalone project that contains all the binaries.</p>
<p>One of the example projects using the SwiftPM for cross-platform development is the Swift server-side web framework, <a href="https://github.com/vapor/vapor">Vapor</a>. Vapor runs happily on both macOS and Linux instances. Nevertheless, developing Swift code for both platforms might not be as easy as you imagine. There are many differences in the Foundation developed for Apple OSes and Linux versions. Therefore, some alignments might be necessary in order to run the code on both systems and this may be the reason why some libraries cannot simply be used on both systems.</p>
<figure>
<img src="assets/SwiftPM.png" alt="SwiftPM with Vapor application" /><figcaption aria-hidden="true">SwiftPM with Vapor application</figcaption>
</figure>
<h2 id="conclusion-4">Conclusion</h2>
<p>This chapter gave an introduction to the most common package managers that could be used for managing 3rd party frameworks with ease. Choosing the right one might, unfortunately, not be as obvious as we would wish for. There are trade offs for each one of them. Choosing Cocoapods or SwiftPM at the start and then potentially replacing some of the big libraries with Carthage, to reduce compile times as needed, might be a good way to go. That being said, with the hybrid approach, the project benefits from both feature sets which could speed up everyday development dramatically.</p>
<h1 id="design-patterns">Design Patterns</h1>
<p>Design patterns help developers to solve complex problems in a known, organised, and structured way. Furthermore, when new developers are onboarded, they might already know the patterns used for solving such problem which helps them to gain speed and confidence for development in the new codebase.</p>
<p>The purpose of this book is not to focus on design patterns in detail as there are plenty of books about them already. However, some patterns that are particularly useful when developing such modular architecture are highlighted here.</p>
<h2 id="coordinator">Coordinator</h2>
<p>First of all, let us have a look at the Coordinator pattern, one of the most well known navigation patterns of all times when it comes to iOS development. Coordinator, as its name says, takes care of coordinating the user’s flow throughout the app. In our Application Framework, each domain framework can be represented by its coordinator as an entry point to that domain. The coordinator can then internally instantiate view controllers and their view models and coordinate the presentation flow. For the client, who is using it, all the necessary complexity is abstracted and held in one place. Coordinators usually need to be triggered to take charge with a <code>start</code> method. Such a method could also provide an option for a <code>link</code> or a <code>route</code> which is a deep link which the coordinator can decide to handle or not.</p>
<p>While there are many different implementations of such a pattern, for the sake of the example and our CosmonautApp I chose the simplest implementation.</p>
<p>First, let us have a look at some protocols: File: <code>core/UIComponents/UIComponents/Source/Coordinator.swift</code></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">// DeepLink represents a linking within the coordinator</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> DeepLink <span class="op">{}</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> Coordinator<span class="op">:</span> <span class="dt">AnyObject</span> <span class="op">{</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">childCoordinators</span><span class="op">:</span> <span class="op">[</span>Coordinator<span class="op">]</span> <span class="op">{</span> <span class="kw">get</span> <span class="kw">set</span> <span class="op">}</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">finish</span><span class="op">:</span> <span class="op">((</span>DeepLink<span class="op">?)</span> <span class="op">-&gt;</span> Void<span class="op">)?</span> <span class="op">{</span> <span class="kw">get</span> <span class="kw">set</span> <span class="op">}</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">start</span><span class="op">()</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">start</span><span class="op">(</span><span class="va">link</span><span class="op">:</span> <span class="dt">DeepLink</span><span class="op">)</span> -&gt; <span class="fu">Bool</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>// <span class="fu">Representation</span> <span class="fu">of</span> <span class="fu">a</span> <span class="fu">coordinator</span> <span class="fu">who</span> <span class="kw">is</span> <span class="fu">using</span> <span class="fu">navigationController</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> <span class="fu">NavigationCoordinator</span><span class="op">:</span> <span class="dt">Coordinator</span> <span class="op">{</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">navigationController</span><span class="op">:</span> UINavigationController <span class="op">{</span> <span class="kw">get</span> <span class="kw">set</span> <span class="op">}</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Representation of a coordinator who is using tabBarController</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> TabBarCoordinator<span class="op">:</span> <span class="dt">Coordinator</span> <span class="op">{</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">tabBarController</span><span class="op">:</span> UITabBarController <span class="op">{</span> <span class="kw">get</span> <span class="kw">set</span> <span class="op">}</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">tabViewController</span><span class="op">:</span> TabBarViewController <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> TabBarViewController<span class="op">:</span> <span class="dt">UIViewController</span> <span class="op">{</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">tabBarImage</span><span class="op">:</span> UIImage <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">tabBarName</span><span class="op">:</span> String <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>To see how those protocols are used in action we can have a look at the CosmonautCoordinator. File: <code>domain/Cosmonaut/Cosmonaut/Source/CosmonautCoordinator.swift</code></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CosmonautCoordinator<span class="op">:</span> <span class="dt">NavigationCoordinator</span> <span class="op">{</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">enum</span> CosmonautLink <span class="op">{</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> info</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">lazy</span> <span class="kw">var</span> <span class="va">navigationController</span><span class="op">:</span> UINavigationController <span class="op">=</span> UINavigationController<span class="op">()</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">var</span> <span class="va">childCoordinators</span><span class="op">:</span> <span class="op">[</span>Coordinator<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">init</span><span class="op">()</span> <span class="op">{}</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">func</span> <span class="fu">start</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>        navigationController<span class="op">.</span>setViewControllers<span class="op">([</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>            makeCosmonautViewController<span class="op">()</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">],</span> animated<span class="op">:</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">func</span> <span class="fu">start</span><span class="op">(</span><span class="va">link</span><span class="op">:</span> <span class="dt">DeepLink</span><span class="op">)</span> -&gt; <span class="fu">Bool</span> <span class="op">{</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">link</span> <span class="op">=</span> link <span class="kw">as</span><span class="op">?</span> CosmonautLink <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="kw">false</span> <span class="op">}</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// </span><span class="al">TODO</span><span class="co">: handle rute</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">true</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">makeCosmonautViewController</span><span class="op">()</span> -&gt; <span class="fu">UIViewController</span> <span class="op">{</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> ComsonautViewController<span class="op">()</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>After hooking up the coordinator into the App window, with for example the main <code>AppCoordinator</code> defined in the <code>Scaffold</code> module, simply calling <code>start()</code> or <code>start(link: CosmonautLink.info)</code> will take over the flow of the particular domain or user’s flow.</p>
<h2 id="strategy">Strategy</h2>
<p>One of my favourite patterns is Strategy, even though I create it in a slightly different way than it was originally intended. Strategy pattern is particularly helpful when developing reusable components, like for example views. Such a view can be initialised with a certain <code>strategy</code> or a <code>type</code>. In traditional book examples, strategy pattern is often described and defined via protocols and the ability to exchange the protocol with a different implementation that conforms to it. However, there is a much more Swift-like way to achieve the same goal with ease, <code>enum</code>. Enum can simply represent a strategy for each case for the object and via enum functions, the necessary logic can be implemented. Surely, the enum can be abstracted by some protocol.</p>
<h2 id="configuration">Configuration</h2>
<p>Configuration is great for all the services and components that serve more than one purpose which will highly likely happen as we are developing many apps on top of the same reusable services. Configuration is a simple object that describes how an instance of the desired object should look or behave. That could be as simple as setting SSLPinning for a network service or setting a name to a CoreData context and so on.</p>
<p>As an example in the Application Framework, we can have a look at the <code>AppCoordinator</code> where the <code>Configuration</code> is defined in its extension. File: <code>domain/Scaffold/Scaffold/Source/AppCoordinator.swift</code></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> AppCoordinator <span class="op">{</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">struct</span> Configuration <span class="op">{</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="kw">enum</span> PresentatinStyle <span class="op">{</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> tabBar<span class="op">,</span> navigation</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="kw">var</span> <span class="va">style</span><span class="op">:</span> PresentatinStyle</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="kw">var</span> <span class="va">menuCoordinator</span><span class="op">:</span> Coordinator<span class="op">?</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="kw">init</span><span class="op">(</span>style<span class="op">:</span> PresentatinStyle<span class="op">,</span> menuCoordinator<span class="op">:</span> Coordinator<span class="op">?)</span> <span class="op">{</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>style <span class="op">=</span> style</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>menuCoordinator <span class="op">=</span> menuCoordinator</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>AppCoordinator takes the configuration object and performs necessary actions based on its values to provide the desired behaviour.</p>
<p>File: <code>domain/Scaffold/Scaffold/Source/AppCoordinator.swift</code></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AppCoordinator<span class="op">:</span> <span class="dt">Coordinator</span> <span class="op">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">init</span><span class="op">(</span>window<span class="op">:</span> UIWindow<span class="op">,</span> configuration<span class="op">:</span> Configuration<span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>configuration <span class="op">=</span> configuration</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>window <span class="op">=</span> window</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="decoupling">Decoupling</h2>
<p>It can surely happen that at some point a different implementation of some protocol must be used. However, that may prove to be much harder than you might think. Imagine a scenario where a CosmonautService (protocol) is used all over our ComsonautApp. Then imagine it was decided that this app will have two different flavours, one for US cosmonaut and one for Russian cosmonaut. The cosmonaut service logic can be huge, 3rd party libraries that are used might also differ and surely we do not want to include unused libraries with our US ComsonautApp or vice versa, that would be shipping a dead code! In that case, we have to decouple those two frameworks and provide a common interface to them in a separate framework.</p>
<p>In such a case we have to make one exception to our Application Framework linking law. For example, let us call it the <code>CosmonautServiceCore</code> framework that would be representing the public interfaces for the higher layers. It would contain protocols and necessary objects that need to be exposed out of the framework to the outer world. <code>USCosmonautService</code> and <code>RUCosmonautService</code> would then link the <code>CosmonautServiceCore</code> on the same hierarchy level and would provide the implementations of protocols defined there.</p>
<p>In such a case, since there is no cross-linking of those interfaces, frameworks, and their implementations, it is fine to link it that way. The higher level framework or, even better, the main App itself, in our example, <code>CosmonautApp</code> would then be based on the availability of the linked framework instantiated the objects represented in the <code>CosmonautServiceCore</code> from the framework that was linked to it. Which would be either <code>USCosmonautService</code> or <code>RUCosmonautService</code>.</p>
<p>This example is not part of the source code demo although such a scenario can happen. Nonetheless it is important to keep the solution for such a problem in mind.</p>
<h2 id="mvvm-c">MVVM + C</h2>
<p>Probably no need for much explanation for Model, View, ViewModel with Coordinator pattern, however, there are many different approaches and implementations. First of all, sometimes it is not necessary to use MVVM as the plain old classic MVC can do the trick as well without the necessity of having an extra object. Second of all, the way in which objects are bound together matters.</p>
<h2 id="protocol-oriented-programming-pop">Protocol Oriented Programming (POP)</h2>
<p>The most beautiful way of extending any kind of functionality of an object is probably via protocols and their extensions. In some cases, like for structs or enums, it is also the only way. In Swift, structs and enums cannot use inheritance. On the other hand, protocols can use inheritance so as a composition for defining the desired behaviour which gives the developer the freedom to design fine granular components with all OOP features.</p>
<h2 id="conclusion-5">Conclusion</h2>
<p>The purpose of this chapter was only to mention the most important patterns that helps when developing modular architecture. I would highly recommend deep diving more into this topic via books that are specially focused on such topic.</p>
<h1 id="project-automation">Project Automation</h1>
<p>When it comes to a project where many developers are contributing simultaneously, automation will become a crucial part of its success. It might be hard in the very beginning to imagine what kind of tasks might be automated but it will become crystal clear during the development phase. It can be as simple as generating the <code>xcodeproj</code> projects with XcodeGen like in our example to avoid conflicts. Automation can also be used to pull new translation strings, generate entitlements on the fly, and can be used to build the app on the CI as well as publishing it to the AppStore or other distribution centre (CD).</p>
<h2 id="fastlane">Fastlane</h2>
<p>First and foremost in the way of automation is iOS developers beloved <code>Fastlane</code>. Fastlane is probably the biggest automation help when it comes to iOS development. It contains a countless amount of plugins that can be used to support project automation. With Fastlane, it is also easy to create your own plugins that will be project-specific only. Fastlane is developed in Ruby and its plugins are as well. However, since all is built with Ruby, Fastlane gives the freedom to import any other ruby projects or classes developed in plain Ruby and directly call them from the Fastlane’s recognisable function so-called <code>lane</code>.</p>
<p>As an example, we can have a look at the Fastfile’s <code>make_new_project</code> lane introduced in the very beginning. In this case the so-called <code>ProjectFactory</code> class is implemented in <code>/fastlane/scripts/ProjectFactory/</code> and imported into the Fastfile. Then it is used as a normal Ruby program. It is NOT purposely developed as a Fastlane’s action. The reason being that it is much easier to develop a pure Ruby program as the program unlike Fastlane’s action does not require the whole Fastlane’s ecosystem to be launched. Launching Fastlane takes a couple of seconds at its best. Perhaps obviously, Fastlane’s action surely comes with its advantages as well, like Fastlane’s action listings, direct execution and so on.</p>
<p><code>/fastlane/Fastfile</code></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">require_relative</span> <span class="st">&quot;scripts/ProjectFactory/project_factory&quot;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>lane <span class="wa">:make_new_project</span> <span class="cf">do</span> <span class="kw">|</span>options<span class="kw">|</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  type <span class="kw">=</span> options<span class="kw">[</span><span class="wa">:type</span><span class="kw">]</span> <span class="co"># Project type can be either app or framework</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  project_name <span class="kw">=</span> options<span class="kw">[</span><span class="wa">:project_name</span><span class="kw">]</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  destination_path <span class="kw">=</span> options<span class="kw">[</span><span class="wa">:destination_path</span><span class="kw">]</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="cn">UI</span><span class="at">.error</span> <span class="st">&quot;💥app_name and destination_path must be provided.💥&quot;</span> <span class="cf">unless</span> project_name <span class="kw">&amp;&amp;</span> destination_path</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>  factory <span class="kw">=</span> <span class="dt">ProjectFactory</span><span class="at">.new</span> project_name, destination_path</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  type <span class="kw">==</span> <span class="st">&quot;app&quot;</span> ? factory<span class="at">.make_new_app</span> : factory<span class="at">.make_new_framework</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div>
<p>Creating a proper Fastlane’s plugin out of the Ruby program could be easily done by following this <a href="https://docs.fastlane.tools/plugins/create-plugin/">documentation</a>.</p>
<p>Fastlane gives the ultimate home for the whole project automation which will prevent script duplications and help with organising and finding necessary actions. To check what is available already in the house of automation, Fastlane can be executed out of the command line and it will give you the option to choose from the publicly available <code>lanes</code> that are already implemented.</p>
<p>Furthermore, we will need a central place where we can execute those scripts to free the developers’ resources. There are many different CI/CD providers that offers pretty much the same solution with very similar setups and problems.</p>
<h2 id="continuous-integration-ci">Continuous Integration (CI)</h2>
<p>To grow a codebase that scales fast, it is crucial to maintain and ensure its quality. In order to achieve that developers are writing the following tests and checks that are then executed by the CI pipeline before the merge can proceed;</p>
<ul>
<li><em>Unit tests</em>, ensure that the logic of the code remained the same</li>
<li><em>UI tests</em>, ensure that the UI looks the same after the change</li>
<li><em>Integration tests</em>, ensure that the app as a whole has all the libraries, launches fine, does not crash on start or at some parts</li>
<li><em>Acceptance tests</em>, ensure that the business level remains the same, meaning, the app provides the business defined value and even though the app might have some minor issues the business value is maintained</li>
<li><em>Others</em>, there might be other kinds of tests implemented within the tests, like for example test that all languages have 100% translations strings, latest app documents are attached, an offline database is updated and so on</li>
</ul>
<figure>
<img src="assets/CI-pipeline.png" alt="CI Pipeline Success Example" /><figcaption aria-hidden="true">CI Pipeline Success Example</figcaption>
</figure>
<p>If everything goes well and all tests are passing, the merge request can be approved and merged by the CI and CD takes it over. On the other hand, if something breaks, developers then need to provide fixes on their changes or adjustment to those tests to reflect their latest changes.</p>
<figure>
<img src="assets/CI-pipeline-failure.png" alt="CI Pipeline Failure Example" /><figcaption aria-hidden="true">CI Pipeline Failure Example</figcaption>
</figure>
<h2 id="continuous-delivery-cd">Continuous Delivery (CD)</h2>
<p>As soon as the merge is done continuous delivery can start. In order to quickly detect if something goes wrong (fail fast) when, for example the pipeline has not detected a breaking change or due to any other reason, alpha builds are created. An Alpha build reflects the latest development state of the codebase. Ideally, developers should work in a way where the development state of the codebase is always production-ready. They should do so in such a way that if some hot-fixes in production are needed the production build can be triggered from the development state immediately. This approach avoids any bug-fixing by cherry-picking and forces developers to commit high-quality atomic commits onto the codebase.</p>
<p>Based on the project, different build configurations can be produced. Build configurations could specify different environments, different identifiers, different secrets to service providers and so on.</p>
<figure>
<img src="assets/CD-pipeline.png" alt="CD Pipeline Example" /><figcaption aria-hidden="true">CD Pipeline Example</figcaption>
</figure>
<h2 id="ruby-programmers-best-friend">Ruby, programmer’s best friend</h2>
<p>If you have not learned it yet, do so, it’s great.</p>
<h2 id="conclusion-6">Conclusion</h2>
<p>CI/CD is a crucial part of every bigger project and unfortunately as of today maintaining pipelines is difficult. Especially in fast-paced projects. Many things can go wrong, 3rd party dependencies CDN might go down for some time, something works locally but not on the CI, different versioning of tools, failing tests, Xcode can cause lots of headaches and so on. Needless to mention the configuration of the CI/CD itself.</p>
<p>The purpose of this chapter was to introduce the concept on a higher level. To deep dive into CI/CD, the documentation of the provider is the best read.</p>
<p>Furthermore, to deep dive more into this topic, I would recommend this article and free ebook.</p>
<p>https://blog.codemagic.io/the-complete-guide-to-ci-cd/ https://codemagic.io/ci-cd-ebook/</p>
<h1 id="the-end">THE END</h1>
<p>When everything goes well, containers will get shipped on the boat to the end customers and life of all is great. However, if it gets stuck at Suez same as the Evergreen ferry, do not panic. It is just software and everything is fixable (unless you ran bad code on top of the production database with Schrödinger’s backup policy. In that case may all the network bandwidth be with you). Sometimes it just takes time and lots of work but in the end, the ferry with its containers will depart and leave towards the customers.</p>
<figure>
<img src="assets/port.jpg" alt="Libraries ready to be dispatched" /><figcaption aria-hidden="true">Libraries ready to be dispatched</figcaption>
</figure>
<p>If you have reached this page then I would like to thank you very much for reading this book and I hope it enlightened you at least at some parts of the development of modular architecture.</p>
<p>Do not hesitate at all to shoot me an <a href="mailto:info@cyrilcermak.com">email</a> if you have any questions, suggestions or just want to drop a few lines.</p>
<p>Thanks!</p>
<h1 id="licence">Licence</h1>
<p>Copyright © 2021 Cyril Cermak.</p>
<p>All rights reserved. This book or any portion thereof may not be reproduced or used in any manner whatsoever without the express written permission of the publisher except for the use of brief quotations in a book review.</p>
<p>Publisher Cyril Cermak</p>
<p>www.cyrilcermak.com</p>
<p>x§</p>
